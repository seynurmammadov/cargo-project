var _a;
import { ApplicationUtil } from "./app-util";
import { FormProvider } from "./form-provider";
import { RegexValidator } from "./regex-validator";
import { AnnotationTypes } from "../core/validator.static";
import { ObjectMaker } from "./object-maker";
import { getConfigObject } from "../util/config-provider";
var operatorOpposite = (_a = {},
    _a[AnnotationTypes.greaterThan] = AnnotationTypes.lessThan,
    _a[AnnotationTypes.lessThan] = AnnotationTypes.greaterThan,
    _a[AnnotationTypes.greaterThanEqualTo] = AnnotationTypes.lessThanEqualTo,
    _a[AnnotationTypes.lessThanEqualTo] = AnnotationTypes.greaterThanEqualTo,
    _a);
export function relationalCheck(control, config, relationalOperatorName) {
    config = getConfigObject(config, control);
    var matchControl = config.fieldName ? ApplicationUtil.getFormControl(config.fieldName, control) : undefined;
    var matchControlValue = (matchControl) ? matchControl.value : config.value !== undefined ? config.value : '';
    if (FormProvider.ProcessRule(control, config)) {
        if (config.isArrayControl)
            return arrayControlValidation(control, config, relationalOperatorName);
        if (isValid(control, matchControlValue, relationalOperatorName) === false)
            return ObjectMaker.toJson(relationalOperatorName, config, [control.value, matchControlValue]);
    }
    return ObjectMaker.null();
}
function isValid(control, matchControlValue, relationalOperatorName) {
    if (RegexValidator.isNotBlank(control.value) && RegexValidator.isNotBlank(matchControlValue)) {
        var isValid_1 = false;
        switch (relationalOperatorName) {
            case AnnotationTypes.greaterThan:
                isValid_1 = parseFloat(control.value) > parseFloat(matchControlValue);
                break;
            case AnnotationTypes.lessThan:
                isValid_1 = parseFloat(control.value) < parseFloat(matchControlValue);
                break;
            case AnnotationTypes.greaterThanEqualTo:
                isValid_1 = parseFloat(control.value) >= parseFloat(matchControlValue);
                break;
            case AnnotationTypes.lessThanEqualTo:
                isValid_1 = parseFloat(control.value) <= parseFloat(matchControlValue);
                break;
        }
        return isValid_1;
    }
    return null;
}
function setTimeFunc(invalidateControls) {
    var timeOut = setTimeout(function () {
        invalidateControls.forEach(function (t) {
            t.updateValueAndValidity();
        });
        clearTimeout(timeOut);
    }, 200);
}
function arrayControlValidation(control, config, relationalOperatorName) {
    var formArray = ApplicationUtil.getParentFormArray(control);
    var parentFormGroup = control.parent ? control.parent : undefined;
    var oppositeOperator = operatorOpposite[relationalOperatorName];
    var updateValidityControls = [];
    if (formArray && parentFormGroup && formArray.controls.length > 1) {
        var indexOf = formArray.controls.indexOf(parentFormGroup);
        var fieldName = ApplicationUtil.getFormControlName(control);
        var valid = true;
        if (indexOf > 0)
            valid = validateControl(formArray, control, indexOf - 1, fieldName, oppositeOperator, relationalOperatorName, updateValidityControls);
        if (valid && formArray.controls.length > indexOf + 1)
            valid = validateControl(formArray, control, indexOf + 1, fieldName, relationalOperatorName, relationalOperatorName, updateValidityControls);
        if (updateValidityControls.length > 0)
            setTimeFunc(updateValidityControls);
        if (valid === false)
            return ObjectMaker.toJson(relationalOperatorName, config, [control.value]);
    }
    return ObjectMaker.null();
}
function validateControl(formArray, control, indexOf, fieldName, oppositeOperator, relationalOperatorName, updateValidityControls) {
    var valid = false;
    var formGroup = formArray.controls[indexOf];
    if (formGroup && formGroup.controls) {
        var formControl = formGroup.controls[fieldName];
        valid = isValid(control, formControl.value, oppositeOperator);
        if (valid && formControl.errors && formControl.errors[relationalOperatorName])
            updateValidityControls.push(formControl);
    }
    return valid;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpb25hbC1jaGVja2VyLmZ1bmN0aW9uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHJ4d2ViL3JlYWN0aXZlLWZvcm0tdmFsaWRhdG9ycy8iLCJzb3VyY2VzIjpbInV0aWwvcmVsYXRpb25hbC1jaGVja2VyLmZ1bmN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzNELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDMUQsSUFBTSxnQkFBZ0I7SUFDbEIsR0FBQyxlQUFlLENBQUMsV0FBVyxJQUFHLGVBQWUsQ0FBQyxRQUFRO0lBQ3ZELEdBQUMsZUFBZSxDQUFDLFFBQVEsSUFBRyxlQUFlLENBQUMsV0FBVztJQUN2RCxHQUFDLGVBQWUsQ0FBQyxrQkFBa0IsSUFBRyxlQUFlLENBQUMsZUFBZTtJQUNyRSxHQUFDLGVBQWUsQ0FBQyxlQUFlLElBQUcsZUFBZSxDQUFDLGtCQUFrQjtPQUN4RSxDQUFBO0FBQ0QsTUFBTSxVQUFVLGVBQWUsQ0FBQyxPQUF3QixFQUFFLE1BQVcsRUFBRSxzQkFBOEI7SUFDakcsTUFBTSxHQUFHLGVBQWUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDMUMsSUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDOUcsSUFBTSxpQkFBaUIs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QzVDLElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxRQUFRLEVBQUU7UUFDakMsSUFBSSxXQUFXLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNoRCxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDOUQsSUFBSSxLQUFLLElBQUksV0FBVyxDQUFDLE1BQU0sSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFDO1lBQ3pFLHNCQUFzQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztLQUNoRDtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wgfSBmcm9tIFwiQGFuZ3VsYXIvZm9ybXNcIjtcclxuaW1wb3J0IHsgQXBwbGljYXRpb25VdGlsIH0gZnJvbSBcIi4vYXBwLXV0aWxcIjtcclxuaW1wb3J0IHsgRm9ybVByb3ZpZGVyIH0gZnJvbSBcIi4vZm9ybS1wcm92aWRlclwiO1xyXG5pbXBvcnQgeyBSZWdleFZhbGlkYXRvciB9IGZyb20gXCIuL3JlZ2V4LXZhbGlkYXRvclwiO1xyXG5pbXBvcnQgeyBBbm5vdGF0aW9uVHlwZXMgfSBmcm9tIFwiLi4vY29yZS92YWxpZGF0b3Iuc3RhdGljXCI7XHJcbmltcG9ydCB7IE9iamVjdE1ha2VyIH0gZnJvbSBcIi4vb2JqZWN0LW1ha2VyXCI7XHJcbmltcG9ydCB7IGdldENvbmZpZ09iamVjdCB9IGZyb20gXCIuLi91dGlsL2NvbmZpZy1wcm92aWRlclwiO1xyXG5jb25zdCBvcGVyYXRvck9wcG9zaXRlOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge1xyXG4gICAgW0Fubm90YXRpb25UeXBlcy5ncmVhdGVyVGhhbl06IEFubm90YXRpb25UeXBlcy5sZXNzVGhhbixcclxuICAgIFtBbm5vdGF0aW9uVHlwZXMubGVzc1RoYW5dOiBBbm5vdGF0aW9uVHlwZXMuZ3JlYXRlclRoYW4sXHJcbiAgICBbQW5ub3RhdGlvblR5cGVzLmdyZWF0ZXJUaGFuRXF1YWxUb106IEFubm90YXRpb25UeXBlcy5sZXNzVGhhbkVxdWFsVG8sXHJcbiAgICBbQW5ub3RhdGlvblR5cGVzLmxlc3NUaGFuRXF1YWxUb106IEFubm90YXRpb25UeXBlcy5ncmVhdGVyVGhhbkVxdWFsVG8sXHJcbn1cclxuZXhwb3J0IGZ1bmN0aW9uIHJlbGF0aW9uYWxDaGVjayhjb250cm9sOiBBYnN0cmFjdENvbnRyb2wsIGNvbmZpZzogYW55LCByZWxhdGlvbmFsT3BlcmF0b3JOYW1lOiBzdHJpbmcpIHtcclxuICAgIGNvbmZpZyA9IGdldENvbmZpZ09iamVjdChjb25maWcsIGNvbnRyb2wpO1xyXG4gICAgY29uc3QgbWF0Y2hDb250cm9sID0gY29uZmlnLmZpZWxkTmFtZSA/IEFwcGxpY2F0aW9uVXRpbC5nZXRGb3JtQ29udHJvbChjb25maWcuZmllbGROYW1lLCBjb250cm9sKSA6IHVuZGVmaW5lZDtcclxuICAgIGNvbnN0IG1hdGNoQ29udHJvbFZhbHVlID0gKG1hdGNoQ29udHJvbCkgPyBtYXRjaENvbnRyb2wudmFsdWUgOiBjb25maWcudmFsdWUgIT09IHVuZGVmaW5lZCA/IGNvbmZpZy52YWx1ZSA6ICcnO1xyXG4gICAgaWYgKEZvcm1Qcm92aWRlci5Qcm9jZXNzUnVsZShjb250cm9sLCBjb25maWcpKSB7XHJcbiAgICAgICAgaWYgKGNvbmZpZy5pc0FycmF5Q29udHJvbClcclxuICAgICAgICAgICAgcmV0dXJuIGFycmF5Q29udHJvbFZhbGlkYXRpb24oY29udHJvbCwgY29uZmlnLCByZWxhdGlvbmFsT3BlcmF0b3JOYW1lKVxyXG4gICAgICAgIGlmIChpc1ZhbGlkKGNvbnRyb2wsIG1hdGNoQ29udHJvbFZhbHVlLCByZWxhdGlvbmFsT3BlcmF0b3JOYW1lKSA9PT0gZmFsc2UpXHJcbiAgICAgICAgICAgIHJldHVybiBPYmplY3RNYWtlci50b0pzb24ocmVsYXRpb25hbE9wZXJhdG9yTmFtZSwgY29uZmlnLCBbY29udHJvbC52YWx1ZSwgbWF0Y2hDb250cm9sVmFsdWVdKTtcclxuICAgIH1cclxuICAgIHJldHVybiBPYmplY3RNYWtlci5udWxsKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzVmFsaWQoY29udHJvbCwgbWF0Y2hDb250cm9sVmFsdWUsIHJlbGF0aW9uYWxPcGVyYXRvck5hbWUpIHtcclxuICAgIGlmIChSZWdleFZhbGlkYXRvci5pc05vdEJsYW5rKGNvbnRyb2wudmFsdWUpICYmIFJlZ2V4VmFsaWRhdG9yLmlzTm90QmxhbmsobWF0Y2hDb250cm9sVmFsdWUpKSB7XHJcbiAgICAgICAgbGV0IGlzVmFsaWQgPSBmYWxzZTtcclxuICAgICAgICBzd2l0Y2ggKHJlbGF0aW9uYWxPcGVyYXRvck5hbWUpIHtcclxuICAgICAgICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZXMuZ3JlYXRlclRoYW46XHJcbiAgICAgICAgICAgICAgICBpc1ZhbGlkID0gcGFyc2VGbG9hdChjb250cm9sLnZhbHVlKSA+IHBhcnNlRmxvYXQobWF0Y2hDb250cm9sVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGVzLmxlc3NUaGFuOlxyXG4gICAgICAgICAgICAgICAgaXNWYWxpZCA9IHBhcnNlRmxvYXQoY29udHJvbC52YWx1ZSkgPCBwYXJzZUZsb2F0KG1hdGNoQ29udHJvbFZhbHVlKVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGVzLmdyZWF0ZXJUaGFuRXF1YWxUbzpcclxuICAgICAgICAgICAgICAgIGlzVmFsaWQgPSBwYXJzZUZsb2F0KGNvbnRyb2wudmFsdWUpID49IHBhcnNlRmxvYXQobWF0Y2hDb250cm9sVmFsdWUpXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZXMubGVzc1RoYW5FcXVhbFRvOlxyXG4gICAgICAgICAgICAgICAgaXNWYWxpZCA9IHBhcnNlRmxvYXQoY29udHJvbC52YWx1ZSkgPD0gcGFyc2VGbG9hdChtYXRjaENvbnRyb2xWYWx1ZSlcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaXNWYWxpZDtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcbmZ1bmN0aW9uIHNldFRpbWVGdW5jKGludmFsaWRhdGVDb250cm9sczogQWJzdHJhY3RDb250cm9sW10pIHtcclxuICAgIGxldCB0aW1lT3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgaW52YWxpZGF0ZUNvbnRyb2xzLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgIHQudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVPdXQpO1xyXG4gICAgfSwgMjAwKVxyXG59XHJcbmZ1bmN0aW9uIGFycmF5Q29udHJvbFZhbGlkYXRpb24oY29udHJvbCwgY29uZmlnLCByZWxhdGlvbmFsT3BlcmF0b3JOYW1lKSB7XHJcbiAgICBsZXQgZm9ybUFycmF5ID0gQXBwbGljYXRpb25VdGlsLmdldFBhcmVudEZvcm1BcnJheShjb250cm9sKTtcclxuICAgIGxldCBwYXJlbnRGb3JtR3JvdXAgPSBjb250cm9sLnBhcmVudCA/IGNvbnRyb2wucGFyZW50IDogdW5kZWZpbmVkO1xyXG4gICAgbGV0IG9wcG9zaXRlT3BlcmF0b3IgPSBvcGVyYXRvck9wcG9zaXRlW3JlbGF0aW9uYWxPcGVyYXRvck5hbWVdO1xyXG4gICAgbGV0IHVwZGF0ZVZhbGlkaXR5Q29udHJvbHMgPSBbXTtcclxuICAgIGlmIChmb3JtQXJyYXkgJiYgcGFyZW50Rm9ybUdyb3VwICYmIGZvcm1BcnJheS5jb250cm9scy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgbGV0IGluZGV4T2YgPSBmb3JtQXJyYXkuY29udHJvbHMuaW5kZXhPZihwYXJlbnRGb3JtR3JvdXApO1xyXG4gICAgICAgIGxldCBmaWVsZE5hbWUgPSBBcHBsaWNhdGlvblV0aWwuZ2V0Rm9ybUNvbnRyb2xOYW1lKGNvbnRyb2wpO1xyXG4gICAgICAgIGxldCB2YWxpZCA9IHRydWU7XHJcbiAgICAgICAgaWYgKGluZGV4T2YgPiAwKVxyXG4gICAgICAgICAgICB2YWxpZCA9IHZhbGlkYXRlQ29udHJvbChmb3JtQXJyYXksIGNvbnRyb2wsIGluZGV4T2YgLSAxLCBmaWVsZE5hbWUsIG9wcG9zaXRlT3BlcmF0b3IsIHJlbGF0aW9uYWxPcGVyYXRvck5hbWUsIHVwZGF0ZVZhbGlkaXR5Q29udHJvbHMpXHJcblxyXG4gICAgICAgIGlmICh2YWxpZCAmJiBmb3JtQXJyYXkuY29udHJvbHMubGVuZ3RoID4gaW5kZXhPZiArIDEpIFxyXG4gICAgICAgICAgICB2YWxpZCA9IHZhbGlkYXRlQ29udHJvbChmb3JtQXJyYXksIGNvbnRyb2wsIGluZGV4T2YgKyAxLCBmaWVsZE5hbWUsIHJlbGF0aW9uYWxPcGVyYXRvck5hbWUsIHJlbGF0aW9uYWxPcGVyYXRvck5hbWUsIHVwZGF0ZVZhbGlkaXR5Q29udHJvbHMpO1xyXG5cclxuICAgICAgICBpZiAodXBkYXRlVmFsaWRpdHlDb250cm9scy5sZW5ndGggPiAwKVxyXG4gICAgICAgICAgICBzZXRUaW1lRnVuYyh1cGRhdGVWYWxpZGl0eUNvbnRyb2xzKTtcclxuICAgICAgICBpZiAodmFsaWQgPT09IGZhbHNlKVxyXG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0TWFrZXIudG9Kc29uKHJlbGF0aW9uYWxPcGVyYXRvck5hbWUsIGNvbmZpZywgW2NvbnRyb2wudmFsdWVdKVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIE9iamVjdE1ha2VyLm51bGwoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gdmFsaWRhdGVDb250cm9sKGZvcm1BcnJheSwgY29udHJvbCwgaW5kZXhPZiwgZmllbGROYW1lLCBvcHBvc2l0ZU9wZXJhdG9yLCByZWxhdGlvbmFsT3BlcmF0b3JOYW1lLCB1cGRhdGVWYWxpZGl0eUNvbnRyb2xzKSB7XHJcbiAgICBsZXQgdmFsaWQgPSBmYWxzZTtcclxuICAgIGxldCBmb3JtR3JvdXAgPSBmb3JtQXJyYXkuY29udHJvbHNbaW5kZXhPZl07XHJcbiAgICBpZiAoZm9ybUdyb3VwICYmIGZvcm1Hcm91cC5jb250cm9scykge1xyXG4gICAgICAgIGxldCBmb3JtQ29udHJvbCA9IGZvcm1Hcm91cC5jb250cm9sc1tmaWVsZE5hbWVdO1xyXG4gICAgICAgIHZhbGlkID0gaXNWYWxpZChjb250cm9sLCBmb3JtQ29udHJvbC52YWx1ZSwgb3Bwb3NpdGVPcGVyYXRvcik7XHJcbiAgICAgICAgaWYgKHZhbGlkICYmIGZvcm1Db250cm9sLmVycm9ycyAmJiBmb3JtQ29udHJvbC5lcnJvcnNbcmVsYXRpb25hbE9wZXJhdG9yTmFtZV0pXHJcbiAgICAgICAgICAgIHVwZGF0ZVZhbGlkaXR5Q29udHJvbHMucHVzaChmb3JtQ29udHJvbCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsaWQ7XHJcbn0iXX0=