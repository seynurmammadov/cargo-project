import * as tslib_1 from "tslib";
import { FormArray } from "@angular/forms";
import { VALUE_CHANGED_SYNC, PATCH } from "../const/app.const";
import { isMatched, clone } from './entity.service';
import { ObjectMaker } from '../util/object-maker';
var PROP_ARRAY = "propArray";
var RxFormArray = /** @class */ (function (_super) {
    tslib_1.__extends(RxFormArray, _super);
    function RxFormArray(arrayObject, controls, validatorOrOpts, asyncValidator, arrayConfig) {
        var _this = _super.call(this, controls, validatorOrOpts, asyncValidator) || this;
        _this.arrayObject = arrayObject;
        _this.arrayConfig = arrayConfig;
        _this._isModified = false;
        _this._modified = [];
        _this.cloneObject(arrayObject);
        return _this;
    }
    Object.defineProperty(RxFormArray.prototype, "isModified", {
        get: function () {
            return this._isModified;
        },
        enumerable: true,
        configurable: true
    });
    RxFormArray.prototype.push = function (control, isAddedInstance) {
        if (isAddedInstance === void 0) { isAddedInstance = false; }
        var formGroup = this.root;
        if (this.arrayObject)
            if (control.modelInstance) {
                if (!isAddedInstance)
                    this.arrayObject.push(control.modelInstance);
                else
                    this.arrayObject[this.arrayObject.length] = control.modelInstance;
            }
        _super.prototype.push.call(this, control);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    };
    RxFormArray.prototype.patch = function () {
        this.checkModification();
        if (this.parent)
            this.parent[PATCH]();
    };
    RxFormArray.prototype.resetForm = function (options) {
        if (options && options.index >= 0 && options.groupOption) {
            this.controls[options.index].resetForm(options.groupOption);
        }
        else {
            for (var i = 0; i < this._baseValue.length; i++) {
                if (this.controls[i] !== undefined)
                    this.controls[i].resetForm({ value: this._baseValue[i] });
                else if (options && options.pushFunction) {
                    var formGroup = options.pushFunction(this._baseValue[i]);
                    this.push(formGroup);
                }
            }
        }
    };
    RxFormArray.prototype.commit = function () {
        var e_1, _a;
        this._baseValue = [];
        try {
            for (var _b = tslib_1.__values(this.controls), _c = _b.next(); !_c.done; _c = _b.next()) {
                var formGroup = _c.value;
                formGroup.commit();
                this._baseValue.push(clone(formGroup.value));
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this.patch();
    };
    RxFormArray.prototype.removeAt = function (index, isRemovedInstance) {
        if (isRemovedInstance === void 0) { isRemovedInstance = false; }
        var formGroup = this.root;
        if (!isRemovedInstance)
            this.arrayObject.splice(index, 1);
        else {
            for (var i = index; i < this.arrayObject.length - 1; i++)
                this.arrayObject[i] = this.arrayObject[i + 1];
            this.arrayObject.pop();
        }
        _super.prototype.removeAt.call(this, index);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    };
    RxFormArray.prototype.checkValidation = function () {
        var _this = this;
        setTimeout(function () {
            if (_this.arrayConfig != undefined && _this.arrayConfig.allowMaxIndex && _this.length > _this.arrayConfig.allowMaxIndex)
                _this.setErrors(ObjectMaker.toJson(PROP_ARRAY, _this.arrayConfig, [_this.length, _this.arrayConfig.allowMaxIndex]));
            else if (_this.errors && _this.errors[PROP_ARRAY])
                delete _this.errors[PROP_ARRAY];
        });
    };
    RxFormArray.prototype.checkModification = function () {
        this._isModified = !(this._baseValue.length == this.controls.length);
        if (!this._isModified)
            for (var i = 0; i < this.controls.length; i++) {
                this._isModified = isMatched(this._baseValue[i], this.controls[i].value);
                if (this._isModified)
                    break;
            }
    };
    RxFormArray.prototype.cloneObject = function (value) {
        var e_2, _a;
        this._baseValue = [];
        try {
            for (var value_1 = tslib_1.__values(value), value_1_1 = value_1.next(); !value_1_1.done; value_1_1 = value_1.next()) {
                var row = value_1_1.value;
                this._baseValue.push(clone(row));
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (value_1_1 && !value_1_1.done && (_a = value_1.return)) _a.call(value_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    return RxFormArray;
}(FormArray));
export { RxFormArray };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicngtZm9ybS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9yeC1mb3JtLWFycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLEtBQUssRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFBO0FBQ2xELElBQU0sVUFBVSxHQUFXLFdBQVcsQ0FBQztBQUN2QztJQUFpQyx1Q0FBUztJQUl0QyxxQkFBb0IsV0FBa0IsRUFBRSxRQUFRLEVBQUUsZUFBcUIsRUFBRSxjQUFvQixFQUFVLFdBQTZEO1FBQXBLLFlBQ0ksa0JBQU0sUUFBUSxFQUFFLGVBQWUsRUFBRSxjQUFjLENBQUMsU0FFbkQ7UUFIbUIsaUJBQVcsR0FBWCxXQUFXLENBQU87UUFBaUUsaUJBQVcsR0FBWCxXQUFXLENBQWtEO1FBRjVKLGlCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGVBQVMsR0FBVSxFQUFFLENBQUM7UUFHMUIsS0FBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQzs7SUFDbEMsQ0FBQztJQUVELHNCQUFJLG1DQUFVO2FBQWQ7WUFDSSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFFRCwwQkFBSSxHQUFKLFVBQUssT0FBWSxFQUFFLGVBQWdDO1FBQWhDLGdDQUFBLEVBQUEsdUJBQWdDO1FBQy9DLElBQUksU0FBUyxHQUFRLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBSSxJQUFJLENBQUMsV0FBVztZQUNoQixJQUFJLE9BQU8sQ0FBQyxhQUFhLEVB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QkFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFBO2dCQUN4RSxJQUFJLElBQUksQ0FBQyxXQUFXO29CQUNoQixNQUFNO2FBQ2I7SUFDVCxDQUFDO0lBRU8saUNBQVcsR0FBbkIsVUFBb0IsS0FBWTs7UUFDNUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7O1lBQ3JCLEtBQWdCLElBQUEsVUFBQSxpQkFBQSxLQUFLLENBQUEsNEJBQUEsK0NBQUU7Z0JBQWxCLElBQUksR0FBRyxrQkFBQTtnQkFDUixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQzthQUNwQzs7Ozs7Ozs7O0lBQ0wsQ0FBQztJQUdMLGtCQUFDO0FBQUQsQ0FBQyxBQXRIRCxDQUFpQyxTQUFTLEdBc0h6QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm1BcnJheSB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xyXG5pbXBvcnQgeyBWQUxVRV9DSEFOR0VEX1NZTkMsIFBBVENIIH0gZnJvbSBcIi4uL2NvbnN0L2FwcC5jb25zdFwiO1xyXG5pbXBvcnQgeyBpc01hdGNoZWQsIGNsb25lIH0gZnJvbSAnLi9lbnRpdHkuc2VydmljZSdcclxuaW1wb3J0IHsgUmVzZXRGb3JtVHlwZSB9IGZyb20gXCIuLi9lbnVtcy9yZXNldC10eXBlXCI7XHJcbmltcG9ydCB7IE9iamVjdE1ha2VyIH0gZnJvbSAnLi4vdXRpbC9vYmplY3QtbWFrZXInXHJcbmNvbnN0IFBST1BfQVJSQVk6IHN0cmluZyA9IFwicHJvcEFycmF5XCI7XHJcbmV4cG9ydCBjbGFzcyBSeEZvcm1BcnJheSBleHRlbmRzIEZvcm1BcnJheSB7XHJcbiAgICBwcml2YXRlIF9iYXNlVmFsdWU6IGFueVtdO1xyXG4gICAgcHJpdmF0ZSBfaXNNb2RpZmllZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBfbW9kaWZpZWQ6IGFueVtdID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFycmF5T2JqZWN0OiBhbnlbXSwgY29udHJvbHMsIHZhbGlkYXRvck9yT3B0cz86IGFueSwgYXN5bmNWYWxpZGF0b3I/OiBhbnksIHByaXZhdGUgYXJyYXlDb25maWc/OiB7IGFsbG93TWF4SW5kZXg/OiBudW1iZXIsIG1lc3NhZ2VLZXk/OiBzdHJpbmcgfSkge1xyXG4gICAgICAgIHN1cGVyKGNvbnRyb2xzLCB2YWxpZGF0b3JPck9wdHMsIGFzeW5jVmFsaWRhdG9yKTtcclxuICAgICAgICB0aGlzLmNsb25lT2JqZWN0KGFycmF5T2JqZWN0KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgaXNNb2RpZmllZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faXNNb2RpZmllZDtcclxuICAgIH1cclxuXHJcbiAgICBwdXNoKGNvbnRyb2w6IGFueSwgaXNBZGRlZEluc3RhbmNlOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgICAgICBsZXQgZm9ybUdyb3VwOiBhbnkgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgaWYgKHRoaXMuYXJyYXlPYmplY3QpXHJcbiAgICAgICAgICAgIGlmIChjb250cm9sLm1vZGVsSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNBZGRlZEluc3RhbmNlKVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3QucHVzaChjb250cm9sLm1vZGVsSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3RbdGhpcy5hcnJheU9iamVjdC5sZW5ndGhdID0gY29udHJvbC5tb2RlbEluc3RhbmNlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgc3VwZXIucHVzaChjb250cm9sKTtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW1ZBTFVFX0NIQU5HRURfU1lOQ10pXHJcbiAgICAgICAgICAgIGZvcm1Hcm91cC52YWx1ZUNoYW5nZWRTeW5jKClcclxuICAgICAgICB0aGlzLnBhdGNoKClcclxuICAgICAgICB0aGlzLmNoZWNrVmFsaWRhdGlvbigpXHJcbiAgICB9XHJcblxyXG4gICAgcGF0Y2goKSB7XHJcbiAgICAgICAgdGhpcy5jaGVja01vZGlmaWNhdGlvbigpO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudClcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRbUEFUQ0hdKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0Rm9ybShvcHRpb25zPzoge1xyXG4gICAgICAgIGluZGV4OiBudW1iZXIsXHJcbiAgICAgICAgZ3JvdXBPcHRpb246IHtcclxuICAgICAgICAgICAgcmVzZXRUeXBlPzogUmVzZXRGb3JtVHlwZSxcclxuICAgICAgICAgICAgd2l0aD86IHN0cmluZ1tdLFxyXG4gICAgICAgICAgICB2YWx1ZT86IHsgW2tleTogc3RyaW5nXTogYW55IH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHB1c2hGdW5jdGlvbjogKHZhbHVlOiBPYmplY3QpID0+IGJvb2xlYW47XHJcbiAgICB9KSB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pbmRleCA+PSAwICYmIG9wdGlvbnMuZ3JvdXBPcHRpb24pIHtcclxuICAgICAgICAgICAgKDxhbnk+dGhpcy5jb250cm9sc1tvcHRpb25zLmluZGV4XSkucmVzZXRGb3JtKG9wdGlvbnMuZ3JvdXBPcHRpb24pXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9iYXNlVmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xzW2ldICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgKDxhbnk+dGhpcy5jb250cm9sc1tpXSkucmVzZXRGb3JtKHsgdmFsdWU6IHRoaXMuX2Jhc2VWYWx1ZVtpXSB9KTtcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnB1c2hGdW5jdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZm9ybUdyb3VwID0gb3B0aW9ucy5wdXNoRnVuY3Rpb24odGhpcy5fYmFzZVZhbHVlW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoKGZvcm1Hcm91cCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgY29tbWl0KCkge1xyXG4gICAgICAgIHRoaXMuX2Jhc2VWYWx1ZSA9IFtdXHJcbiAgICAgICAgZm9yIChsZXQgZm9ybUdyb3VwIG9mIHRoaXMuY29udHJvbHMpIHtcclxuICAgICAgICAgICAgKDxhbnk+Zm9ybUdyb3VwKS5jb21taXQoKTtcclxuICAgICAgICAgICAgdGhpcy5fYmFzZVZhbHVlLnB1c2goY2xvbmUoZm9ybUdyb3VwLnZhbHVlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucGF0Y2goKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVtb3ZlQXQoaW5kZXg6IG51bWJlciwgaXNSZW1vdmVkSW5zdGFuY2U6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG4gICAgICAgIGxldCBmb3JtR3JvdXA6IGFueSA9IHRoaXMucm9vdDtcclxuICAgICAgICBpZiAoIWlzUmVtb3ZlZEluc3RhbmNlKVxyXG4gICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmRleDsgaSA8IHRoaXMuYXJyYXlPYmplY3QubGVuZ3RoIC0gMTsgaSsrKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5hcnJheU9iamVjdFtpXSA9IHRoaXMuYXJyYXlPYmplY3RbaSArIDFdO1xyXG4gICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0LnBvcCgpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHN1cGVyLnJlbW92ZUF0KGluZGV4KTtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW1ZBTFVFX0NIQU5HRURfU1lOQ10pXHJcbiAgICAgICAgICAgIGZvcm1Hcm91cC52YWx1ZUNoYW5nZWRTeW5jKClcclxuICAgICAgICB0aGlzLnBhdGNoKClcclxuICAgICAgICB0aGlzLmNoZWNrVmFsaWRhdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tWYWxpZGF0aW9uKCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hcnJheUNvbmZpZyAhPSB1bmRlZmluZWQgJiYgdGhpcy5hcnJheUNvbmZpZy5hbGxvd01heEluZGV4ICYmIHRoaXMubGVuZ3RoID4gdGhpcy5hcnJheUNvbmZpZy5hbGxvd01heEluZGV4KVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRFcnJvcnMoT2JqZWN0TWFrZXIudG9Kc29uKFBST1BfQVJSQVksIHRoaXMuYXJyYXlDb25maWcsIFt0aGlzLmxlbmd0aCwgdGhpcy5hcnJheUNvbmZpZy5hbGxvd01heEluZGV4XSkpO1xyXG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVycm9ycyAmJiB0aGlzLmVycm9yc1tQUk9QX0FSUkFZXSlcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmVycm9yc1tQUk9QX0FSUkFZXTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tNb2RpZmljYXRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5faXNNb2RpZmllZCA9ICEodGhpcy5fYmFzZVZhbHVlLmxlbmd0aCA9PSB0aGlzLmNvbnRyb2xzLmxlbmd0aCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9pc01vZGlmaWVkKVxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuY29udHJvbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2lzTW9kaWZpZWQgPSBpc01hdGNoZWQodGhpcy5fYmFzZVZhbHVlW2ldLCB0aGlzLmNvbnRyb2xzW2ldLnZhbHVlKVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2lzTW9kaWZpZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsb25lT2JqZWN0KHZhbHVlOiBhbnlbXSkge1xyXG4gICAgICAgIHRoaXMuX2Jhc2VWYWx1ZSA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IHJvdyBvZiB2YWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9iYXNlVmFsdWUucHVzaChjbG9uZShyb3cpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxufVxyXG4iXX0=