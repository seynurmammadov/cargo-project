import * as tslib_1 from "tslib";
import { defaultContainer } from "../core/defaultContainer";
import { OBJECT_PROPERTY } from "../const/validator.const";
import { ApplicationUtil } from "../util/app-util";
import { RXCODE, MODEL_INSTANCE } from "../const/app.const";
import { instanceProvider } from "../util/instance-provider.function";
var DisableProvider = /** @class */ (function () {
    function DisableProvider(decoratorType, entityObject) {
        this.decoratorType = decoratorType;
        this.entityObject = entityObject;
    }
    DisableProvider.prototype.getFormGroupName = function (currentFormGroup) {
        var e_1, _a;
        var keyName = '';
        if (currentFormGroup.parent)
            try {
                for (var _b = tslib_1.__values(Object.keys(currentFormGroup.parent.controls)), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var controlName = _c.value;
                    if (currentFormGroup.parent.controls[controlName] == currentFormGroup) {
                        keyName = controlName;
                        break;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        return keyName;
    };
    DisableProvider.prototype.zeroArgumentProcess = function (control, columnName) {
        var disabledColumns = [];
        this.getDisabledColumns(control.parent, "" + columnName + RXCODE + "0", false).forEach(function (t) { return disabledColumns.push(t); });
        var path = this.topControlPath(control, columnName);
        var splitPath = path.split(".");
        if (splitPath.length > 1) {
            var rootFormGroup = ApplicationUtil.getRootFormGroup(control);
            this.getDisabledColumns(rootFormGroup, "" + path + RXCODE + "0", true).forEach(function (t) { return disabledColumns.push(t); });
            var controlPath = '';
            for (var i = 0; i < splitPath.length - 2; i++) {
                var controlName = splitPath[i];
                controlPath = "" + path.replace(controlName + ".", '') + RXCODE + "-0";
                if (rootFormGroup.controls[controlName]) {
                    this.getDisabledColumns(rootFormGroup.controls[controlName], controlPath, true, controlName).forEach(function (t) { return disabledColumns.push(t); });
                    rootFormGroup = rootFormGroup.controls[controlName];
                }
            }
        }
        return disabledColumns;
    };
    DisableProvider.prototype.getDisabledColumns = function (formGroup, columnName, isRoot, pathName) {
        if (pathName === void 0) { pathName = ""; }
        if (formGroup[MODEL_INSTANCE]) {
            var instanceContainer = instanceProvider(formGroup[MODEL_INSTANCE].constructor, this.entityObject);
            return this.getChangeDetectionColumns(instanceContainer, columnName, isRoot, pathName);
        }
        return [];
    };
    DisableProvider.prototype.getChangeDetectionColumns = function (instanceContainer, columnName, isRoot, pathName) {
        var _this = this;
        if (pathName === void 0) { pathName = ""; }
        var conditionalDisableControls = [];
        var columns = instanceContainer.nonValidationDecorators[this.decoratorType].changeDetection[columnName];
        if (columns) {
            columns.forEach(function (t) {
                conditionalDisableControls.push({ controlPath: pathName ? pathName + "." + t : t, conditionalExpression: instanceContainer.nonValidationDecorators[_this.decoratorType].conditionalExpressions[t], isRoot: isRoot });
            });
        }
        return conditionalDisableControls;
    };
    DisableProvider.prototype.topControlPath = function (control, columnName) {
        if (control.parent) {
            var name_1 = this.getFormGroupName(control.parent);
            if (name_1) {
                columnName = name_1 + "." + columnName;
                return this.topControlPath(control.parent, columnName);
            }
        }
        return columnName;
    };
    DisableProvider.prototype.childControlDisabledExpression = function (formGroup, columnName, path) {
        var _this = this;
        if (path === void 0) { path = ""; }
        var disabledColumns = [];
        if (formGroup[MODEL_INSTANCE]) {
            var instanceContainer = defaultContainer.get(formGroup[MODEL_INSTANCE].constructor);
            if (instanceContainer) {
                this.getChangeDetectionColumns(instanceContainer, columnName, true, path).forEach(function (t) { return disabledColumns.push(t); });
                var props = instanceContainer.properties.filter(function (t) { return t.propertyType == OBJECT_PROPERTY; });
                props.forEach(function (t) {
                    if (formGroup.controls[t.name]) {
                        var columns = _this.getDisabledColumns(formGroup.controls[t.name], columnName, true, path ? path + "." + t.name : "" + t.name);
                        columns.forEach(function (x) { return disabledColumns.push(x); });
                        _this.childControlDisabledExpression(formGroup.controls[t.name], columnName, path ? path + "." + t.name : "" + t.name).forEach(function (y) { return disabledColumns.push(y); });
                    }
                });
            }
        }
        return disabledColumns;
    };
    DisableProvider.prototype.oneArgumentProcess = function (control, columnName) {
        var path = this.topControlPath(control, columnName);
        var rootFormGroup = ApplicationUtil.getRootFormGroup(control);
        var childColumns = this.childControlDisabledExpression(rootFormGroup, path);
        return childColumns;
    };
    return DisableProvider;
}());
export { DisableProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzYWJsZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJkb21haW4vZGlzYWJsZS1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBCQUEwQixDQUFBO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBRXJFO0lBRUkseUJBQW9CLGFBQXFCLEVBQVUsWUFBZ0M7UUFBL0Qsa0JBQWEsR0FBYixhQUFhLENBQVE7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBb0I7SUFFbkYsQ0FBQztJQUlELDBDQUFnQixHQUFoQixVQUFpQixnQkFBMEI7O1FBQ3ZDLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLGdCQUFnQixDQUFDLE1BQU07O2dCQUMzQixLQUF3QixJQUFBLEtBQUEsaUJBQUEsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUEsZ0JBQUE7b0JBQWhFLElBQUksV0FBVyxXQUFBO29CQUNoQixJQUFJLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksZ0JBQWdCLEVBQUU7d0JBQ25FLE9BQU8sR0FBRyxXQUFXLENBQUM7d0JBQ3RCLE1BQU07cUJBQ1Q7aUJBQUE7Ozs7Ozs7O2FBQUE7UUFDTCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsNkNBQW1CLEdBQW5CLFVBQW9CLE9BQXVCLEVBQUMsVUFBaUI7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SjtRQUNELE9BQU8sZUFBZSxDQUFDO0lBQzNCLENBQUM7SUFFRCw0Q0FBa0IsR0FBbEIsVUFBbUIsT0FBbUMsRUFBQyxVQUFpQjtRQUNwRSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBQyxVQUFVLENBQUMsQ0FBQztRQUNuRCxJQUFJLGFBQWEsR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUQsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixDQUFDLGFBQWEsRUFBQyxJQUFJLENBQUMsQ0FBQztRQUMzRSxPQUFPLFlBQVksQ0FBQztJQUN4QixDQUFDO0lBQ0wsc0JBQUM7QUFBRCxDQUFDLEFBaEdELElBZ0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwLEFic3RyYWN0Q29udHJvbCB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiXHJcbmltcG9ydCB7IGRlZmF1bHRDb250YWluZXIgfSBmcm9tIFwiLi4vY29yZS9kZWZhdWx0Q29udGFpbmVyXCI7XHJcbmltcG9ydCB7IEluc3RhbmNlQ29udGFpbmVyIH0gZnJvbSBcIi4uL2NvcmUvdmFsaWRhdG9yLmludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBPQkpFQ1RfUFJPUEVSVFkgfSBmcm9tIFwiLi4vY29uc3QvdmFsaWRhdG9yLmNvbnN0XCJcclxuaW1wb3J0IHsgQXBwbGljYXRpb25VdGlsIH0gZnJvbSBcIi4uL3V0aWwvYXBwLXV0aWxcIjtcclxuaW1wb3J0IHsgUlhDT0RFLCBNT0RFTF9JTlNUQU5DRSB9IGZyb20gXCIuLi9jb25zdC9hcHAuY29uc3RcIjtcclxuaW1wb3J0IHsgaW5zdGFuY2VQcm92aWRlciB9IGZyb20gXCIuLi91dGlsL2luc3RhbmNlLXByb3ZpZGVyLmZ1bmN0aW9uXCJcclxuXHJcbmV4cG9ydCBjbGFzcyBEaXNhYmxlUHJvdmlkZXJ7XHJcbiAgICBcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZGVjb3JhdG9yVHlwZTogc3RyaW5nLCBwcml2YXRlIGVudGl0eU9iamVjdDoge1trZXk6c3RyaW5nXTphbnl9KXtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgXHJcblxyXG4gICAgZ2V0Rm9ybUdyb3VwTmFtZShjdXJyZW50Rm9ybUdyb3VwOkZvcm1Hcm91cCkge1xyXG4gICAgICAgIGxldCBrZXlOYW1lID0gJyc7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRGb3JtR3JvdXAucGFyZW50KVxyXG4gICAgICAgIGZvciAodmFyIGNvbnRyb2xOYW1lIG9mIE9iamVjdC5rZXlzKGN1cnJlbnRGb3JtR3JvdXAucGFyZW50LmNvbnRyb2xzKSlcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRGb3JtR3JvdXAucGFyZW50LmNvbnRyb2xzW2NvbnRyb2xOYW1lXSA9PSBjdXJyZW50Rm9ybUdyb3VwKSB7XHJcbiAgICAgICAgICAgICAgICBrZXlOYW1lID0gY29udHJvbE5hbWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBrZXlOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHplcm9Bcmd1bWVudFByb2Nlc3MoY29udHJvbDpBYnN0cmFjdENvbnRyb2wsY29sdW1uTmFtZTpzdHJpbmcpe1xyXG4gICAgICAgIGxldCBkaXNhYmxlZENvbHVtbnMgPSBbXTsgICAgXHJcbiAgICAgICAgdGhpcy5nZXREaXNhYmxlZENvbHVtbnMoPEZvcm1Hcm91cD5jb250cm9sLnBhcmVudCxgJHtjb2x1bW5OYW1lfSR7UlhDT0RFfTBgLGZhbHNlKS5mb3JFYWNoKHQ9PmRpc2FibGVkQ29sdW1ucy5wdXNoKHQpKTtcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMudG9wQ29udHJvbFBhdGgoY29udHJvbCxjb2x1bW5OYW1lKTtcclxuICAgICAgICBsZXQgc3BsaXRQYXRoID0gcGF0aC5zcGxpdChcIi5cIik7XHJcbiAgICAgICAgaWYoc3BsaXRQYXRoLmxlbmd0aCA+IDEpe1xyXG4gICAgICAgICAgICBsZXQgcm9vdEZvcm1Hcm91cCA9IEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGNvbnRyb2wpO1xyXG4gICAgICAgICAgICB0aGlzLmdldERpc2FibGVkQ29sdW1ucyhyb290Rm9ybUdyb3VwLGAke3BhdGh9JHtSWENPREV9MGAsdHJ1ZSkuZm9yRWFjaCh0PT5kaXNhYmxlZENvbHVtbnMucHVzaCh0KSk7XHJcbiAgICAgICAgICAgIGxldCBjb250cm9sUGF0aDpzdHJpbmcgPSAnJztcclxuICAgICAgICAgICAgZm9yKHZhciBpPTA7aTxzcGxpdFBhdGgubGVuZ3RoIC0yO2krKyl7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29udHJvbE5hbWUgPSBzcGxpdFBhdGhbaV07XHJcbiAgICAgICAgICAgICAgICBjb250cm9sUGF0aCA9YCR7cGF0aC5yZXBsYWNlKGAke2NvbnRyb2xOYW1lfS5gLCcnKX0ke1JYQ09ERX0tMGBcclxuICAgICAgICAgICAgICAgIGlmKHJvb3RGb3JtR3JvdXAuY29udHJvbHNbY29udHJvbE5hbWVdKXtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldERpc2FibGVkQ29sdW1ucyg8Rm9ybUdyb3VwPnJvb3RGb3JtR3JvdXAuY29udHJvbHNbY29udHJvbE5hbWVdLGNvbnRyb2xQYXRoLHRydWUsY29udHJvbE5hbWUpLmZvckVhY2godD0+ZGlzYWJsZWRDb2x1bW5zLnB1c2godCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJvb3RGb3JtR3JvdXAgPSA8Rm9ybUdyb3VwPnJvb3RGb3JtR3JvdXAuY29udHJvbHNbY29udHJvbE5hbWVdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkaXNhYmxlZENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXREaXNhYmxlZENvbHVtbnMoZm9ybUdyb3VwOkZvcm1Hcm91cCxjb2x1bW5OYW1lOnN0cmluZyxpc1Jvb3Q6Qm9vbGVhbixwYXRoTmFtZTpzdHJpbmcgPSBcIlwiKXtcclxuICAgICAgICBpZihmb3JtR3JvdXBbTU9ERUxfSU5TVEFOQ0VdKXtcclxuICAgICAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyID0gaW5zdGFuY2VQcm92aWRlcihmb3JtR3JvdXBbTU9ERUxfSU5TVEFOQ0VdLmNvbnN0cnVjdG9yLHRoaXMuZW50aXR5T2JqZWN0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hhbmdlRGV0ZWN0aW9uQ29sdW1ucyhpbnN0YW5jZUNvbnRhaW5lcixjb2x1bW5OYW1lLGlzUm9vdCxwYXRoTmFtZSlcclxuICAgICAgICB9cmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0Q2hhbmdlRGV0ZWN0aW9uQ29sdW1ucyhpbnN0YW5jZUNvbnRhaW5lcjpJbnN0YW5jZUNvbnRhaW5lcixjb2x1bW5OYW1lOnN0cmluZyxpc1Jvb3Q6Qm9vbGVhbixwYXRoTmFtZTpzdHJpbmcgPSBcIlwiKXtcclxuICAgICAgICBsZXQgY29uZGl0aW9uYWxEaXNhYmxlQ29udHJvbHMgPSBbXTtcclxuICAgICAgICBsZXQgY29sdW1ucyA9IGluc3RhbmNlQ29udGFpbmVyLm5vblZhbGlkYXRpb25EZWNvcmF0b3JzW3RoaXMuZGVjb3JhdG9yVHlwZV0uY2hhbmdlRGV0ZWN0aW9uW2NvbHVtbk5hbWVdXHJcbiAgICAgICAgaWYoY29sdW1ucyl7XHJcbiAgICAgICAgICAgIGNvbHVtbnMuZm9yRWFjaCh0PT57XHJcbiAgICAgICAgICAgICAgICBjb25kaXRpb25hbERpc2FibGVDb250cm9scy5wdXNoKHtjb250cm9sUGF0aDpwYXRoTmFtZSA/IGAke3BhdGhOYW1lfS4ke3R9YDogdCxjb25kaXRpb25hbEV4cHJlc3Npb246aW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnNbdGhpcy5kZWNvcmF0b3JUeXBlXS5jb25kaXRpb25hbEV4cHJlc3Npb25zW3RdLGlzUm9vdDppc1Jvb3R9KVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gY29uZGl0aW9uYWxEaXNhYmxlQ29udHJvbHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0b3BDb250cm9sUGF0aChjb250cm9sOkFic3RyYWN0Q29udHJvbCB8IEZvcm1Hcm91cCxjb2x1bW5OYW1lOnN0cmluZyl7XHJcbiAgICAgICAgaWYoY29udHJvbC5wYXJlbnQpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGxldCBuYW1lID0gdGhpcy5nZXRGb3JtR3JvdXBOYW1lKCg8Rm9ybUdyb3VwPmNvbnRyb2wucGFyZW50KSlcclxuICAgICAgICAgICAgICAgIGlmKG5hbWUpXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uTmFtZSA9IGAke25hbWV9LiR7Y29sdW1uTmFtZX1gXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9wQ29udHJvbFBhdGgoY29udHJvbC5wYXJlbnQsY29sdW1uTmFtZSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gY29sdW1uTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBjaGlsZENvbnRyb2xEaXNhYmxlZEV4cHJlc3Npb24oZm9ybUdyb3VwOkZvcm1Hcm91cCxjb2x1bW5OYW1lOnN0cmluZyxwYXRoOnN0cmluZyA9IFwiXCIpIDphbnlbXSB7XHJcbiAgICAgICAgbGV0IGRpc2FibGVkQ29sdW1ucyA9IFtdO1xyXG4gICAgICAgIGlmKGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0pe1xyXG4gICAgICAgICAgICBsZXQgaW5zdGFuY2VDb250YWluZXIgPSBkZWZhdWx0Q29udGFpbmVyLmdldChmb3JtR3JvdXBbTU9ERUxfSU5TVEFOQ0VdLmNvbnN0cnVjdG9yKTtcclxuICAgICAgICAgICAgaWYoaW5zdGFuY2VDb250YWluZXIpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRDaGFuZ2VEZXRlY3Rpb25Db2x1bW5zKGluc3RhbmNlQ29udGFpbmVyLGNvbHVtbk5hbWUsdHJ1ZSxwYXRoKS5mb3JFYWNoKHQ9PmRpc2FibGVkQ29sdW1ucy5wdXNoKHQpKTtcclxuICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGluc3RhbmNlQ29udGFpbmVyLnByb3BlcnRpZXMuZmlsdGVyKHQgPT4gdC5wcm9wZXJ0eVR5cGUgPT0gT0JKRUNUX1BST1BFUlRZKVxyXG4gICAgICAgICAgICBwcm9wcy5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYoZm9ybUdyb3VwLmNvbnRyb2xzW3QubmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjb2x1bW5zID0gdGhpcy5nZXREaXNhYmxlZENvbHVtbnMoPEZvcm1Hcm91cD5mb3JtR3JvdXAuY29udHJvbHNbdC5uYW1lXSxjb2x1bW5OYW1lLHRydWUscGF0aCA/IGAke3BhdGh9LiR7dC5uYW1lfWAgOmAke3QubmFtZX1gIClcclxuICAgICAgICAgICAgICAgICAgICBjb2x1bW5zLmZvckVhY2goeD0+ZGlzYWJsZWRDb2x1bW5zLnB1c2goeCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRDb250cm9sRGlzYWJsZWRFeHByZXNzaW9uKCg8Rm9ybUdyb3VwPmZvcm1Hcm91cC5jb250cm9sc1t0Lm5hbWVdKSxjb2x1bW5OYW1lLHBhdGggPyBgJHtwYXRofS4ke3QubmFtZX1gIDpgJHt0Lm5hbWV9YCkuZm9yRWFjaCh5PT5kaXNhYmxlZENvbHVtbnMucHVzaCh5KSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGlzYWJsZWRDb2x1bW5zO1xyXG4gICAgfVxyXG5cclxuICAgIG9uZUFyZ3VtZW50UHJvY2Vzcyhjb250cm9sOkFic3RyYWN0Q29udHJvbCB8IEZvcm1Hcm91cCxjb2x1bW5OYW1lOnN0cmluZyk6YW55W117XHJcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLnRvcENvbnRyb2xQYXRoKGNvbnRyb2wsY29sdW1uTmFtZSk7XHJcbiAgICAgICAgbGV0IHJvb3RGb3JtR3JvdXAgPSBBcHBsaWNhdGlvblV0aWwuZ2V0Um9vdEZvcm1Hcm91cChjb250cm9sKTtcclxuICAgICAgICBsZXQgY2hpbGRDb2x1bW5zID0gdGhpcy5jaGlsZENvbnRyb2xEaXNhYmxlZEV4cHJlc3Npb24ocm9vdEZvcm1Hcm91cCxwYXRoKTtcclxuICAgICAgICByZXR1cm4gY2hpbGRDb2x1bW5zO1xyXG4gICAgfVxyXG59Il19