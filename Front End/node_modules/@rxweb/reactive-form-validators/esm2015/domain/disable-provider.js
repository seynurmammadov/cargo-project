import { defaultContainer } from "../core/defaultContainer";
import { OBJECT_PROPERTY } from "../const/validator.const";
import { ApplicationUtil } from "../util/app-util";
import { RXCODE, MODEL_INSTANCE } from "../const/app.const";
import { instanceProvider } from "../util/instance-provider.function";
export class DisableProvider {
    constructor(decoratorType, entityObject) {
        this.decoratorType = decoratorType;
        this.entityObject = entityObject;
    }
    getFormGroupName(currentFormGroup) {
        let keyName = '';
        if (currentFormGroup.parent)
            for (var controlName of Object.keys(currentFormGroup.parent.controls))
                if (currentFormGroup.parent.controls[controlName] == currentFormGroup) {
                    keyName = controlName;
                    break;
                }
        return keyName;
    }
    zeroArgumentProcess(control, columnName) {
        let disabledColumns = [];
        this.getDisabledColumns(control.parent, `${columnName}${RXCODE}0`, false).forEach(t => disabledColumns.push(t));
        let path = this.topControlPath(control, columnName);
        let splitPath = path.split(".");
        if (splitPath.length > 1) {
            let rootFormGroup = ApplicationUtil.getRootFormGroup(control);
            this.getDisabledColumns(rootFormGroup, `${path}${RXCODE}0`, true).forEach(t => disabledColumns.push(t));
            let controlPath = '';
            for (var i = 0; i < splitPath.length - 2; i++) {
                let controlName = splitPath[i];
                controlPath = `${path.replace(`${controlName}.`, '')}${RXCODE}-0`;
                if (rootFormGroup.controls[controlName]) {
                    this.getDisabledColumns(rootFormGroup.controls[controlName], controlPath, true, controlName).forEach(t => disabledColumns.push(t));
                    rootFormGroup = rootFormGroup.controls[controlName];
                }
            }
        }
        return disabledColumns;
    }
    getDisabledColumns(formGroup, columnName, isRoot, pathName = "") {
        if (formGroup[MODEL_INSTANCE]) {
            let instanceContainer = instanceProvider(formGroup[MODEL_INSTANCE].constructor, this.entityObject);
            return this.getChangeDetectionColumns(instanceContainer, columnName, isRoot, pathName);
        }
        return [];
    }
    getChangeDetectionColumns(instanceContainer, columnName, isRoot, pathName = "") {
        let conditionalDisableControls = [];
        let columns = instanceContainer.nonValidationDecorators[this.decoratorType].changeDetection[columnName];
        if (columns) {
            columns.forEach(t => {
                conditionalDisableControls.push({ controlPath: pathName ? `${pathName}.${t}` : t, conditionalExpression: instanceContainer.nonValidationDecorators[this.decoratorType].conditionalExpressions[t], isRoot: isRoot });
            });
        }
        return conditionalDisableControls;
    }
    topControlPath(control, columnName) {
        if (control.parent) {
            let name = this.getFormGroupName(control.parent);
            if (name) {
                columnName = `${name}.${columnName}`;
                return this.topControlPath(control.parent, columnName);
            }
        }
        return columnName;
    }
    childControlDisabledExpression(formGroup, columnName, path = "") {
        let disabledColumns = [];
        if (formGroup[MODEL_INSTANCE]) {
            let instanceContainer = defaultContainer.get(formGroup[MODEL_INSTANCE].constructor);
            if (instanceContainer) {
                this.getChangeDetectionColumns(instanceContainer, columnName, true, path).forEach(t => disabledColumns.push(t));
                var props = instanceContainer.properties.filter(t => t.propertyType == OBJECT_PROPERTY);
                props.forEach(t => {
                    if (formGroup.controls[t.name]) {
                        let columns = this.getDisabledColumns(formGroup.controls[t.name], columnName, true, path ? `${path}.${t.name}` : `${t.name}`);
                        columns.forEach(x => disabledColumns.push(x));
                        this.childControlDisabledExpression(formGroup.controls[t.name], columnName, path ? `${path}.${t.name}` : `${t.name}`).forEach(y => disabledColumns.push(y));
                    }
                });
            }
        }
        return disabledColumns;
    }
    oneArgumentProcess(control, columnName) {
        let path = this.topControlPath(control, columnName);
        let rootFormGroup = ApplicationUtil.getRootFormGroup(control);
        let childColumns = this.childControlDisabledExpression(rootFormGroup, path);
        return childColumns;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzYWJsZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJkb21haW4vZGlzYWJsZS1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUU1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUE7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDNUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0NBQW9DLENBQUE7QUFFckUsTUFBTSxPQUFPLGVBQWU7SUFFeEIsWUFBb0IsYUFBcUIsRUFBVSxZQUFnQztRQUEvRCxrQkFBYSxHQUFiLGFBQWEsQ0FBUTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFvQjtJQUVuRixDQUFDO0lBSUQsZ0JBQWdCLENBQUMsZ0JBQTBCO1FBQ3ZDLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLGdCQUFnQixDQUFDLE1BQU07WUFDM0IsS0FBSyxJQUFJLFdBQVcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7Z0JBQ2pFLElBQUksZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxnQkFBZ0IsRUFBRTtvQkFDbkUsT0FBTyxHQUFHLFdBQVcsQ0FBQztvQkFDdEIsTUFBTTtpQkFDVDtRQUNMLE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxPQUF1QixFQUFDLFVBQWlCO1FBQ3pELElBQUksZUFBZSxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsa0JBQWtCLENB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LENBQUM7UUFDOUQsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixDQUFDLGFBQWEsRUFBQyxJQUFJLENBQUMsQ0FBQztRQUMzRSxPQUFPLFlBQVksQ0FBQztJQUN4QixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JtR3JvdXAsQWJzdHJhY3RDb250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCJcclxuaW1wb3J0IHsgZGVmYXVsdENvbnRhaW5lciB9IGZyb20gXCIuLi9jb3JlL2RlZmF1bHRDb250YWluZXJcIjtcclxuaW1wb3J0IHsgSW5zdGFuY2VDb250YWluZXIgfSBmcm9tIFwiLi4vY29yZS92YWxpZGF0b3IuaW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IE9CSkVDVF9QUk9QRVJUWSB9IGZyb20gXCIuLi9jb25zdC92YWxpZGF0b3IuY29uc3RcIlxyXG5pbXBvcnQgeyBBcHBsaWNhdGlvblV0aWwgfSBmcm9tIFwiLi4vdXRpbC9hcHAtdXRpbFwiO1xyXG5pbXBvcnQgeyBSWENPREUsIE1PREVMX0lOU1RBTkNFIH0gZnJvbSBcIi4uL2NvbnN0L2FwcC5jb25zdFwiO1xyXG5pbXBvcnQgeyBpbnN0YW5jZVByb3ZpZGVyIH0gZnJvbSBcIi4uL3V0aWwvaW5zdGFuY2UtcHJvdmlkZXIuZnVuY3Rpb25cIlxyXG5cclxuZXhwb3J0IGNsYXNzIERpc2FibGVQcm92aWRlcntcclxuICAgIFxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBkZWNvcmF0b3JUeXBlOiBzdHJpbmcsIHByaXZhdGUgZW50aXR5T2JqZWN0OiB7W2tleTpzdHJpbmddOmFueX0pe1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBcclxuXHJcbiAgICBnZXRGb3JtR3JvdXBOYW1lKGN1cnJlbnRGb3JtR3JvdXA6Rm9ybUdyb3VwKSB7XHJcbiAgICAgICAgbGV0IGtleU5hbWUgPSAnJztcclxuICAgICAgICBpZiAoY3VycmVudEZvcm1Hcm91cC5wYXJlbnQpXHJcbiAgICAgICAgZm9yICh2YXIgY29udHJvbE5hbWUgb2YgT2JqZWN0LmtleXMoY3VycmVudEZvcm1Hcm91cC5wYXJlbnQuY29udHJvbHMpKVxyXG4gICAgICAgICAgICBpZiAoY3VycmVudEZvcm1Hcm91cC5wYXJlbnQuY29udHJvbHNbY29udHJvbE5hbWVdID09IGN1cnJlbnRGb3JtR3JvdXApIHtcclxuICAgICAgICAgICAgICAgIGtleU5hbWUgPSBjb250cm9sTmFtZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGtleU5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgemVyb0FyZ3VtZW50UHJvY2Vzcyhjb250cm9sOkFic3RyYWN0Q29udHJvbCxjb2x1bW5OYW1lOnN0cmluZyl7XHJcbiAgICAgICAgbGV0IGRpc2FibGVkQ29sdW1ucyA9IFtdOyAgICBcclxuICAgICAgICB0aGlzLmdldERpc2FibGVkQ29sdW1ucyg8Rm9ybUdyb3VwPmNvbnRyb2wucGFyZW50LGAke2NvbHVtbk5hbWV9JHtSWENPREV9MGAsZmFsc2UpLmZvckVhY2godD0+ZGlzYWJsZWRDb2x1bW5zLnB1c2godCkpO1xyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy50b3BDb250cm9sUGF0aChjb250cm9sLGNvbHVtbk5hbWUpO1xyXG4gICAgICAgIGxldCBzcGxpdFBhdGggPSBwYXRoLnNwbGl0KFwiLlwiKTtcclxuICAgICAgICBpZihzcGxpdFBhdGgubGVuZ3RoID4gMSl7XHJcbiAgICAgICAgICAgIGxldCByb290Rm9ybUdyb3VwID0gQXBwbGljYXRpb25VdGlsLmdldFJvb3RGb3JtR3JvdXAoY29udHJvbCk7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0RGlzYWJsZWRDb2x1bW5zKHJvb3RGb3JtR3JvdXAsYCR7cGF0aH0ke1JYQ09ERX0wYCx0cnVlKS5mb3JFYWNoKHQ9PmRpc2FibGVkQ29sdW1ucy5wdXNoKHQpKTtcclxuICAgICAgICAgICAgbGV0IGNvbnRyb2xQYXRoOnN0cmluZyA9ICcnO1xyXG4gICAgICAgICAgICBmb3IodmFyIGk9MDtpPHNwbGl0UGF0aC5sZW5ndGggLTI7aSsrKXtcclxuICAgICAgICAgICAgICAgIGxldCBjb250cm9sTmFtZSA9IHNwbGl0UGF0aFtpXTtcclxuICAgICAgICAgICAgICAgIGNvbnRyb2xQYXRoID1gJHtwYXRoLnJlcGxhY2UoYCR7Y29udHJvbE5hbWV9LmAsJycpfSR7UlhDT0RFfS0wYFxyXG4gICAgICAgICAgICAgICAgaWYocm9vdEZvcm1Hcm91cC5jb250cm9sc1tjb250cm9sTmFtZV0pe1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RGlzYWJsZWRDb2x1bW5zKDxGb3JtR3JvdXA+cm9vdEZvcm1Hcm91cC5jb250cm9sc1tjb250cm9sTmFtZV0sY29udHJvbFBhdGgsdHJ1ZSxjb250cm9sTmFtZSkuZm9yRWFjaCh0PT5kaXNhYmxlZENvbHVtbnMucHVzaCh0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcm9vdEZvcm1Hcm91cCA9IDxGb3JtR3JvdXA+cm9vdEZvcm1Hcm91cC5jb250cm9sc1tjb250cm9sTmFtZV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGRpc2FibGVkQ29sdW1ucztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERpc2FibGVkQ29sdW1ucyhmb3JtR3JvdXA6Rm9ybUdyb3VwLGNvbHVtbk5hbWU6c3RyaW5nLGlzUm9vdDpCb29sZWFuLHBhdGhOYW1lOnN0cmluZyA9IFwiXCIpe1xyXG4gICAgICAgIGlmKGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0pe1xyXG4gICAgICAgICAgICBsZXQgaW5zdGFuY2VDb250YWluZXIgPSBpbnN0YW5jZVByb3ZpZGVyKGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0uY29uc3RydWN0b3IsdGhpcy5lbnRpdHlPYmplY3QpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDaGFuZ2VEZXRlY3Rpb25Db2x1bW5zKGluc3RhbmNlQ29udGFpbmVyLGNvbHVtbk5hbWUsaXNSb290LHBhdGhOYW1lKVxyXG4gICAgICAgIH1yZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDaGFuZ2VEZXRlY3Rpb25Db2x1bW5zKGluc3RhbmNlQ29udGFpbmVyOkluc3RhbmNlQ29udGFpbmVyLGNvbHVtbk5hbWU6c3RyaW5nLGlzUm9vdDpCb29sZWFuLHBhdGhOYW1lOnN0cmluZyA9IFwiXCIpe1xyXG4gICAgICAgIGxldCBjb25kaXRpb25hbERpc2FibGVDb250cm9scyA9IFtdO1xyXG4gICAgICAgIGxldCBjb2x1bW5zID0gaW5zdGFuY2VDb250YWluZXIubm9uVmFsaWRhdGlvbkRlY29yYXRvcnNbdGhpcy5kZWNvcmF0b3JUeXBlXS5jaGFuZ2VEZXRlY3Rpb25bY29sdW1uTmFtZV1cclxuICAgICAgICBpZihjb2x1bW5zKXtcclxuICAgICAgICAgICAgY29sdW1ucy5mb3JFYWNoKHQ9PntcclxuICAgICAgICAgICAgICAgIGNvbmRpdGlvbmFsRGlzYWJsZUNvbnRyb2xzLnB1c2goe2NvbnRyb2xQYXRoOnBhdGhOYW1lID8gYCR7cGF0aE5hbWV9LiR7dH1gOiB0LGNvbmRpdGlvbmFsRXhwcmVzc2lvbjppbnN0YW5jZUNvbnRhaW5lci5ub25WYWxpZGF0aW9uRGVjb3JhdG9yc1t0aGlzLmRlY29yYXRvclR5cGVdLmNvbmRpdGlvbmFsRXhwcmVzc2lvbnNbdF0saXNSb290OmlzUm9vdH0pXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjb25kaXRpb25hbERpc2FibGVDb250cm9scztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRvcENvbnRyb2xQYXRoKGNvbnRyb2w6QWJzdHJhY3RDb250cm9sIHwgRm9ybUdyb3VwLGNvbHVtbk5hbWU6c3RyaW5nKXtcclxuICAgICAgICBpZihjb250cm9sLnBhcmVudClcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSB0aGlzLmdldEZvcm1Hcm91cE5hbWUoKDxGb3JtR3JvdXA+Y29udHJvbC5wYXJlbnQpKVxyXG4gICAgICAgICAgICAgICAgaWYobmFtZSlcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2x1bW5OYW1lID0gYCR7bmFtZX0uJHtjb2x1bW5OYW1lfWBcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50b3BDb250cm9sUGF0aChjb250cm9sLnBhcmVudCxjb2x1bW5OYW1lKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjb2x1bW5OYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGNoaWxkQ29udHJvbERpc2FibGVkRXhwcmVzc2lvbihmb3JtR3JvdXA6Rm9ybUdyb3VwLGNvbHVtbk5hbWU6c3RyaW5nLHBhdGg6c3RyaW5nID0gXCJcIikgOmFueVtdIHtcclxuICAgICAgICBsZXQgZGlzYWJsZWRDb2x1bW5zID0gW107XHJcbiAgICAgICAgaWYoZm9ybUdyb3VwW01PREVMX0lOU1RBTkNFXSl7XHJcbiAgICAgICAgICAgIGxldCBpbnN0YW5jZUNvbnRhaW5lciA9IGRlZmF1bHRDb250YWluZXIuZ2V0KGZvcm1Hcm91cFtNT0RFTF9JTlNUQU5DRV0uY29uc3RydWN0b3IpO1xyXG4gICAgICAgICAgICBpZihpbnN0YW5jZUNvbnRhaW5lcil7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldENoYW5nZURldGVjdGlvbkNvbHVtbnMoaW5zdGFuY2VDb250YWluZXIsY29sdW1uTmFtZSx0cnVlLHBhdGgpLmZvckVhY2godD0+ZGlzYWJsZWRDb2x1bW5zLnB1c2godCkpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHByb3BzID0gaW5zdGFuY2VDb250YWluZXIucHJvcGVydGllcy5maWx0ZXIodCA9PiB0LnByb3BlcnR5VHlwZSA9PSBPQkpFQ1RfUFJPUEVSVFkpXHJcbiAgICAgICAgICAgIHByb3BzLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZihmb3JtR3JvdXAuY29udHJvbHNbdC5uYW1lXSl7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGNvbHVtbnMgPSB0aGlzLmdldERpc2FibGVkQ29sdW1ucyg8Rm9ybUdyb3VwPmZvcm1Hcm91cC5jb250cm9sc1t0Lm5hbWVdLGNvbHVtbk5hbWUsdHJ1ZSxwYXRoID8gYCR7cGF0aH0uJHt0Lm5hbWV9YCA6YCR7dC5uYW1lfWAgKVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbnMuZm9yRWFjaCh4PT5kaXNhYmxlZENvbHVtbnMucHVzaCh4KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlsZENvbnRyb2xEaXNhYmxlZEV4cHJlc3Npb24oKDxGb3JtR3JvdXA+Zm9ybUdyb3VwLmNvbnRyb2xzW3QubmFtZV0pLGNvbHVtbk5hbWUscGF0aCA/IGAke3BhdGh9LiR7dC5uYW1lfWAgOmAke3QubmFtZX1gKS5mb3JFYWNoKHk9PmRpc2FibGVkQ29sdW1ucy5wdXNoKHkpKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkaXNhYmxlZENvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgb25lQXJndW1lbnRQcm9jZXNzKGNvbnRyb2w6QWJzdHJhY3RDb250cm9sIHwgRm9ybUdyb3VwLGNvbHVtbk5hbWU6c3RyaW5nKTphbnlbXXtcclxuICAgICAgICBsZXQgcGF0aCA9IHRoaXMudG9wQ29udHJvbFBhdGgoY29udHJvbCxjb2x1bW5OYW1lKTtcclxuICAgICAgICBsZXQgcm9vdEZvcm1Hcm91cCA9IEFwcGxpY2F0aW9uVXRpbC5nZXRSb290Rm9ybUdyb3VwKGNvbnRyb2wpO1xyXG4gICAgICAgIGxldCBjaGlsZENvbHVtbnMgPSB0aGlzLmNoaWxkQ29udHJvbERpc2FibGVkRXhwcmVzc2lvbihyb290Rm9ybUdyb3VwLHBhdGgpO1xyXG4gICAgICAgIHJldHVybiBjaGlsZENvbHVtbnM7XHJcbiAgICB9XHJcbn0iXX0=