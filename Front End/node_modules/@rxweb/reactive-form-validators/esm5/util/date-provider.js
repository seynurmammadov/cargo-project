import * as tslib_1 from "tslib";
import { ReactiveFormConfig } from "./reactive-form-config";
import { ApplicationUtil } from './app-util';
var ISO_DATE_REGEX = /^(?:[\+-]?\d{4}(?!\d{2}\b))(?:(-?)(?:(?:0[1-9]|1[0-2])(?:\1(?:[12]\d|0[1-9]|3[01]))?|W(?:[0-4]\d|5[0-2])(?:-?[1-7])?|(?:00[1-9]|0[1-9]\d|[12]\d{2}|3(?:[0-5]\d|6[1-6])))(?:[T\s](?:(?:(?:[01]\d|2[0-3])(?:(:?)[0-5]\d)?|24\:?00)(?:[\.,]\d+(?!:))?)?(?:\2[0-5]\d(?:[\.,]\d+)?)?(?:[zZ]|(?:[\+-])(?:[01]\d|2[0-3]):?(?:[0-5]\d)?)?)?)?$/;
var DateProvider = /** @class */ (function () {
    function DateProvider() {
    }
    DateProvider.prototype.isDate = function (value) {
        return value instanceof Date && !isNaN(value.valueOf());
    };
    DateProvider.prototype.getRegex = function (dateFormat) {
        var regExp;
        switch (dateFormat) {
            case 'ymd':
                regExp = "^(?:[0-9]{4})-(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])$";
                break;
            case 'dmy':
                regExp = "^(3[01]|[12][0-9]|0?[1-9])-(1[0-2]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
            case 'mdy':
                regExp = "^(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
        }
        return new RegExp(regExp);
    };
    DateProvider.prototype.regex = function () {
        var regExp;
        if (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator)
            regExp = this.getRegex(ReactiveFormConfig.json.internationalization.dateFormat);
        else
            regExp = (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat) ? this.getRegex(ReactiveFormConfig.json.baseConfig.dateFormat) : this.getRegex("mdy");
        return regExp;
    };
    DateProvider.prototype.getDate = function (value, isBaseFormat) {
        var _a, _b, _c;
        if (isBaseFormat === void 0) { isBaseFormat = false; }
        var year, month, day;
        if (!this.isDate(value)) {
            var seperator = void 0;
            var dateFormat = void 0;
            if (ISO_DATE_REGEX.test(value)) {
                return new Date(value);
            }
            else {
                seperator = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.seperator ? ReactiveFormConfig.json.baseConfig.seperator : "/";
                dateFormat = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat ? ReactiveFormConfig.json.baseConfig.dateFormat : "mdy";
            }
            if (!isBaseFormat && ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator) {
                seperator = ReactiveFormConfig.json.internationalization.seperator;
                dateFormat = ReactiveFormConfig.json.internationalization.dateFormat;
            }
            switch (dateFormat) {
                case 'ymd':
                    _a = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), year = _a[0], month = _a[1], day = _a[2];
                    break;
                case 'dmy':
                    _b = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), day = _b[0], month = _b[1], year = _b[2];
                    break;
                case 'mdy':
                    _c = tslib_1.__read(value.split(seperator).map(function (val) { return +val; }), 3), month = _c[0], day = _c[1], year = _c[2];
                    break;
            }
            return new Date(year, month - 1, day);
        }
        else
            return value;
    };
    DateProvider.prototype.isValid = function (value, config) {
        if (typeof value == "string") {
            // Fixed issue : https://github.com/rxweb/rxweb/issues/280 & feature request : https://github.com/rxweb/rxweb/issues/295
            if (config && config.allowISODate && ISO_DATE_REGEX.test(value))
                return true;
            var seperator = '/';
            if (ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.seperator)
                seperator = ReactiveFormConfig.json.internationalization.seperator;
            if (value.split(seperator).length !== 3)
                return false;
            value = value.replace(seperator, '-').replace(seperator, '-');
            return this.regex().test(value);
        }
        else
            return this.isDate(value);
    };
    DateProvider.prototype.getConfigDateValue = function (config) {
        var date = config.value;
        if (config.value && typeof config.value == "string") {
            date = this.getDate(config.value, true);
        }
        return date;
    };
    DateProvider.prototype.getCompareDate = function (config, control) {
        var date = this.getConfigDateValue(config);
        if (config.fieldName) {
            var checkControl = ApplicationUtil.getFormControl(config.fieldName, control);
            if (checkControl && checkControl.value) {
                date = this.getDate(checkControl.value);
            }
        }
        return date;
    };
    return DateProvider;
}());
export { DateProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJ1dGlsL2RhdGUtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDNUMsSUFBTSxjQUFjLEdBQUcsd1VBQXdVLENBQUM7QUFDaFc7SUFBQTtJQWlHQSxDQUFDO0lBL0ZHLDZCQUFNLEdBQU4sVUFBTyxLQUFVO1FBQ2IsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFTywrQkFBUSxHQUFoQixVQUFpQixVQUFrQjtRQUMvQixJQUFJLE1BQWMsQ0FBQztRQUNuQixRQUFRLFVBQVUsRUFBRTtZQUNoQixLQUFLLEtBQUs7Z0JBQ04sTUFBTSxHQUFHLDJEQUEyRCxDQUFDO2dCQUNyRSxNQUFNO1lBQ1YsS0FBSyxLQUFLO2dCQUNOLE1BQU0sR0FBRyxvRUFBb0UsQ0FBQztnQkFDOUUsTUFBTTtZQUNWLEtBQUssS0FBSztnQkFDTixNQUFNLEdBQUcsb0VBQW9FLENBQUM7Z0JBQzlFLE1BQU07U0FDYjtRQUNELE9BQU8sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELDRCQUFLLEdBQUw7UUFDSSxJQUFJLE1BQWMsQ0FBQztRQUNuQixJQUFJLGtCQUFrQixJQUFJLGtCQUFrQixDQUFDLElBQUksSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLElBQUksa0JBQWtCLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUztZQUNs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QVcsRUFBRSxPQUFZO1FBQ3BDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxZQUFZLEdBQVEsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2xGLElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxLQUFLLEVBQUU7Z0JBQ3BDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUMxQztTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNMLG1CQUFDO0FBQUQsQ0FBQyxBQWpHRCxJQWlHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlYWN0aXZlRm9ybUNvbmZpZyB9IGZyb20gXCIuL3JlYWN0aXZlLWZvcm0tY29uZmlnXCI7XHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uVXRpbCB9IGZyb20gJy4vYXBwLXV0aWwnXHJcbmNvbnN0IElTT19EQVRFX1JFR0VYID0gL14oPzpbXFwrLV0/XFxkezR9KD8hXFxkezJ9XFxiKSkoPzooLT8pKD86KD86MFsxLTldfDFbMC0yXSkoPzpcXDEoPzpbMTJdXFxkfDBbMS05XXwzWzAxXSkpP3xXKD86WzAtNF1cXGR8NVswLTJdKSg/Oi0/WzEtN10pP3woPzowMFsxLTldfDBbMS05XVxcZHxbMTJdXFxkezJ9fDMoPzpbMC01XVxcZHw2WzEtNl0pKSkoPzpbVFxcc10oPzooPzooPzpbMDFdXFxkfDJbMC0zXSkoPzooOj8pWzAtNV1cXGQpP3wyNFxcOj8wMCkoPzpbXFwuLF1cXGQrKD8hOikpPyk/KD86XFwyWzAtNV1cXGQoPzpbXFwuLF1cXGQrKT8pPyg/Olt6Wl18KD86W1xcKy1dKSg/OlswMV1cXGR8MlswLTNdKTo/KD86WzAtNV1cXGQpPyk/KT8pPyQvO1xyXG5leHBvcnQgY2xhc3MgRGF0ZVByb3ZpZGVyIHtcclxuXHJcbiAgICBpc0RhdGUodmFsdWU6IGFueSk6IEJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHZhbHVlLnZhbHVlT2YoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRSZWdleChkYXRlRm9ybWF0OiBzdHJpbmcpOiBSZWdFeHAge1xyXG4gICAgICAgIHZhciByZWdFeHA6IHN0cmluZztcclxuICAgICAgICBzd2l0Y2ggKGRhdGVGb3JtYXQpIHtcclxuICAgICAgICAgICAgY2FzZSAneW1kJzpcclxuICAgICAgICAgICAgICAgIHJlZ0V4cCA9IFwiXig/OlswLTldezR9KS0oMVswLTJdfDA/WzEtOV0pLSgzWzAxXXxbMTJdWzAtOV18MD9bMS05XSkkXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnZG15JzpcclxuICAgICAgICAgICAgICAgIHJlZ0V4cCA9IFwiXigzWzAxXXxbMTJdWzAtOV18MD9bMS05XSktKDFbMC0yXXwwP1sxLTldKS0oPzpbMC05XXsyfSk/WzAtOV17Mn0kXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbWR5JzpcclxuICAgICAgICAgICAgICAgIHJlZ0V4cCA9IFwiXigxWzAtMl18MD9bMS05XSktKDNbMDFdfFsxMl1bMC05XXwwP1sxLTldKS0oPzpbMC05XXsyfSk/WzAtOV17Mn0kXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAocmVnRXhwKTtcclxuICAgIH1cclxuXHJcbiAgICByZWdleCgpIHtcclxuICAgICAgICB2YXIgcmVnRXhwOiBSZWdFeHA7XHJcbiAgICAgICAgaWYgKFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0ICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcilcclxuICAgICAgICAgICAgcmVnRXhwID0gdGhpcy5nZXRSZWdleChSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0KVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgcmVnRXhwID0gKFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCkgPyB0aGlzLmdldFJlZ2V4KFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCkgOiB0aGlzLmdldFJlZ2V4KFwibWR5XCIpO1xyXG4gICAgICAgIHJldHVybiByZWdFeHA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RGF0ZSh2YWx1ZTogc3RyaW5nIHwgRGF0ZSwgaXNCYXNlRm9ybWF0OiBib29sZWFuID0gZmFsc2UpOiBEYXRlIHtcclxuICAgICAgICBsZXQgeWVhciwgbW9udGgsIGRheTtcclxuICAgICAgICBpZiAoIXRoaXMuaXNEYXRlKHZhbHVlKSkge1xyXG4gICAgICAgICAgICBsZXQgc2VwZXJhdG9yOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGxldCBkYXRlRm9ybWF0OiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGlmIChJU09fREFURV9SRUdFWC50ZXN0KDxzdHJpbmc+dmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VwZXJhdG9yID0gUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5zZXBlcmF0b3IgPyBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLnNlcGVyYXRvciA6IFwiL1wiO1xyXG4gICAgICAgICAgICAgICAgZGF0ZUZvcm1hdCA9IFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCA/IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuZGF0ZUZvcm1hdCA6IFwibWR5XCI7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICghaXNCYXNlRm9ybWF0ICYmIFJlYWN0aXZlRm9ybUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5kYXRlRm9ybWF0ICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcikge1xyXG4gICAgICAgICAgICAgICAgc2VwZXJhdG9yID0gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yO1xyXG4gICAgICAgICAgICAgICAgZGF0ZUZvcm1hdCA9IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3dpdGNoIChkYXRlRm9ybWF0KSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICd5bWQnOlxyXG4gICAgICAgICAgICAgICAgICAgIFt5ZWFyLCBtb250aCwgZGF5XSA9ICg8U3RyaW5nPnZhbHVlKS5zcGxpdChzZXBlcmF0b3IpLm1hcCgodmFsOiBzdHJpbmcpID0+ICt2YWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnZG15JzpcclxuICAgICAgICAgICAgICAgICAgICBbZGF5LCBtb250aCwgeWVhcl0gPSAoPFN0cmluZz52YWx1ZSkuc3BsaXQoc2VwZXJhdG9yKS5tYXAoKHZhbDogc3RyaW5nKSA9PiArdmFsKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ21keSc6XHJcbiAgICAgICAgICAgICAgICAgICAgW21vbnRoLCBkYXksIHllYXJdID0gKDxTdHJpbmc+dmFsdWUpLnNwbGl0KHNlcGVyYXRvcikubWFwKCh2YWw6IHN0cmluZykgPT4gK3ZhbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHllYXIsIG1vbnRoIC0gMSwgZGF5KTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIDxEYXRlPnZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGlzVmFsaWQodmFsdWU6IHN0cmluZyB8IERhdGUsIGNvbmZpZzogYW55KTogQm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIC8vIEZpeGVkIGlzc3VlIDogaHR0cHM6Ly9naXRodWIuY29tL3J4d2ViL3J4d2ViL2lzc3Vlcy8yODAgJiBmZWF0dXJlIHJlcXVlc3QgOiBodHRwczovL2dpdGh1Yi5jb20vcnh3ZWIvcnh3ZWIvaXNzdWVzLzI5NVxyXG4gICAgICAgICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5hbGxvd0lTT0RhdGUgJiYgSVNPX0RBVEVfUkVHRVgudGVzdCg8c3RyaW5nPnZhbHVlKSlcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICBsZXQgc2VwZXJhdG9yID0gJy8nXHJcbiAgICAgICAgICAgIGlmIChSZWFjdGl2ZUZvcm1Db25maWcuanNvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbiAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3IpXHJcbiAgICAgICAgICAgICAgICBzZXBlcmF0b3IgPSBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3I7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS5zcGxpdChzZXBlcmF0b3IpLmxlbmd0aCAhPT0gMylcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKHNlcGVyYXRvciwgJy0nKS5yZXBsYWNlKHNlcGVyYXRvciwgJy0nKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVnZXgoKS50ZXN0KHZhbHVlKTtcclxuICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNEYXRlKHZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDb25maWdEYXRlVmFsdWUoY29uZmlnKSB7XHJcbiAgICAgICAgbGV0IGRhdGUgPSBjb25maWcudmFsdWU7XHJcbiAgICAgICAgaWYgKGNvbmZpZy52YWx1ZSAmJiB0eXBlb2YgY29uZmlnLnZhbHVlID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgZGF0ZSA9IHRoaXMuZ2V0RGF0ZShjb25maWcudmFsdWUsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGF0ZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDb21wYXJlRGF0ZShjb25maWc6IGFueSwgY29udHJvbDogYW55KSB7XHJcbiAgICAgICAgbGV0IGRhdGUgPSB0aGlzLmdldENvbmZpZ0RhdGVWYWx1ZShjb25maWcpO1xyXG4gICAgICAgIGlmIChjb25maWcuZmllbGROYW1lKSB7XHJcbiAgICAgICAgICAgIGxldCBjaGVja0NvbnRyb2w6IGFueSA9IEFwcGxpY2F0aW9uVXRpbC5nZXRGb3JtQ29udHJvbChjb25maWcuZmllbGROYW1lLCBjb250cm9sKTtcclxuICAgICAgICAgICAgaWYgKGNoZWNrQ29udHJvbCAmJiBjaGVja0NvbnRyb2wudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIGRhdGUgPSB0aGlzLmdldERhdGUoY2hlY2tDb250cm9sLnZhbHVlKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRlO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==