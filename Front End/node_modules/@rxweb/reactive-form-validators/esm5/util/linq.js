import * as tslib_1 from "tslib";
import { THIS } from "../const/app.const";
var Linq = /** @class */ (function () {
    function Linq() {
    }
    Linq.functionCreator = function (expression) {
        var functionSetter = [];
        var match = expression.match(/^\s*\(?\s*([^)]*)\s*\)?\s*=>(.*)/);
        var splitSelect = match[2].split(",");
        for (var i = 0; i < splitSelect.length; i++) {
            var equalToOperator = splitSelect[i].match(/^\s*\(?\s*([^)]*)\s*\)?\s*|===|!==|==|!=|>=|>|<=|<|(.*)/);
            if (equalToOperator !== null) {
                functionSetter = new Function(match[1], "return " + equalToOperator.input);
            }
            else {
                equalToOperator = splitSelect[i].match(/^\s*\(?\s*([^)]*)\s*\)?\s*=(.*)/);
                if (equalToOperator === null) {
                    functionSetter = new Function(match[1], "return " + splitSelect.input);
                }
                else {
                    functionSetter = new Function(match[1], "return " + equalToOperator.input);
                }
            }
        }
        if (splitSelect.length == 0)
            functionSetter = { accessFunction: new Function(match[1], "return " + match[2]) };
        return functionSetter;
    };
    Linq.execute = function (jObject, config, parentObject, modelInstance, isDynamicConfig) {
        var expressionFunction = isDynamicConfig ? config.dynamicConfig : config.conditionalExpression;
        var lastParam = isDynamicConfig ? config : modelInstance;
        if (parentObject && typeof expressionFunction == "string")
            expressionFunction = Linq.functionCreator(expressionFunction);
        if (parentObject && expressionFunction)
            return modelInstance && modelInstance.constructor !== Object ? expressionFunction.call(modelInstance, parentObject, jObject, lastParam) : expressionFunction(parentObject, jObject, lastParam);
        return true;
    };
    Linq.getConditionPath = function (texts) {
        var path = "";
        for (var i = 1; i < texts.length; i++)
            path += (texts.length - 1) == i ? texts[i].trim() : texts[i].trim() + ".";
        return path;
    };
    Linq.expressionParser = function (expression, isNonValidationExpression) {
        var _this = this;
        var splitExpressions = [];
        var columns = [];
        var expressionString = expression.toString();
        var expressionArguments = Linq.extractArguments(expressionString);
        if (expressionArguments.length > 0) {
            var splitTexts_1 = [];
            expressionString.replace(/\s/g, '').replace(new RegExp(/{|}/, "g"), "").split(new RegExp(/return|===|!==|==|!=|>=|>|<=|<|&&/)).forEach(function (t) {
                var e_1, _a;
                var texts = t.replace(/\(|\)/g, "").split("||");
                try {
                    for (var texts_1 = tslib_1.__values(texts), texts_1_1 = texts_1.next(); !texts_1_1.done; texts_1_1 = texts_1.next()) {
                        var text = texts_1_1.value;
                        splitTexts_1.push(text);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (texts_1_1 && !texts_1_1.done && (_a = texts_1.return)) _a.call(texts_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            });
            splitTexts_1.forEach(function (t) {
                expressionArguments.forEach(function (x, i) {
                    t = t.trim();
                    if (t.startsWith(x + '.')) {
                        var splitText = t.split('.');
                        if (splitText.length == 2 || (splitText.length >= 2 && isNonValidationExpression))
                            if (!isNonValidationExpression)
                                columns.push({ propName: splitText[1].trim(), argumentIndex: i == 3 ? 0 : i == 2 ? 1 : i == 1 ? -1 : i });
                            else
                                columns.push({ propName: _this.getConditionPath(splitText), argumentIndex: i == 3 ? 0 : i == 2 ? 1 : i == 1 ? -1 : i });
                        else {
                            var arrayProp = splitText[1].split('[');
                            var jObject = {
                                propName: splitText[splitText.length - 1].trim(),
                                objectPropName: arrayProp[0],
                                arrayIndex: arrayProp.length > 1 ? arrayProp[1].replace("]", "") : undefined,
                                argumentIndex: i === 3 ? 0 : i === 2 ? 1 : i
                            };
                            columns.push(jObject);
                        }
                    }
                });
            });
        }
        return columns;
    };
    Linq.extractArguments = function (splitText) {
        var expressionArguments = [THIS];
        if (splitText[0].trim() !== "(" && !splitText.trim().startsWith("function")) {
            var text = splitText[0].split("=>")[0];
            expressionArguments.push(text.trim().replace("(", "").replace(")", ""));
        }
        else {
            var splitTexts = splitText.match(/\(([^)]+)\)/g);
            if (splitTexts && splitTexts[0])
                splitTexts[0].split(",").forEach(function (t) { return expressionArguments.push(t.trim().replace("(", "").replace(")", "")); });
        }
        return expressionArguments;
    };
    Linq.expressionColumns = function (expression, isNonValidationExpression) {
        if (isNonValidationExpression === void 0) { isNonValidationExpression = false; }
        var columns = [];
        var splitExpressions = [];
        if (typeof expression == "string") {
            expression.split("=>")[1].split(" && ").forEach(function (t) {
                t.split(" || ").forEach(function (x) {
                    splitExpressions.push(x.trim().split(' ')[0]);
                });
            });
            splitExpressions.forEach(function (t) {
                var splitText = t.split('.');
                if (splitText.length == 2)
                    columns.push({ propName: splitText[1].trim() });
                else {
                    var arrayProp = splitText[1].split('[');
                    var jObject = {
                        propName: splitText[splitText.length - 1].trim(),
                        objectPropName: arrayProp[0],
                        arrayIndex: arrayProp.length > 1 ? arrayProp[1].replace("]", "") : undefined
                    };
                    columns.push(jObject);
                }
            });
        }
        else {
            columns = Linq.expressionParser(expression, isNonValidationExpression);
        }
        return columns;
    };
    Linq.dynamicConfigParser = function (expression, propName) {
        var controlNames = [];
        var expressionString = expression.toString();
        var expressionArguments = Linq.extractArguments(expressionString);
        var splitString = expressionString.replace(new RegExp(/\r?\n|\r|;/g), ' ').replace(/["%()\{}=\\?ï¿½`'#<>|,;:+-]+/g, " ").split(/ /g);
        if (expressionArguments.length > 3)
            expressionArguments.splice(expressionArguments.length - 1, 1);
        expressionArguments.forEach(function (t) {
            splitString.filter(function (x) { return x != t + "." + propName && x.startsWith(t + "."); }).forEach(function (x) {
                var split = x.split('.');
                if (split.length == 2)
                    controlNames.push({ propName: x.replace(t + ".", '') });
                else {
                    var arrayProp = split[1].split('[');
                    var jObject = {
                        propName: split[split.length - 1].trim(),
                        objectPropName: arrayProp[0],
                        arrayIndex: arrayProp.length > 1 ? arrayProp[1].replace("]", "") : undefined,
                    };
                    controlNames.push(jObject);
                }
            });
        });
        return controlNames;
    };
    return Linq;
}());
export { Linq };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlucS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJ1dGlsL2xpbnEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUN6QztJQUFBO0lBa0pBLENBQUM7SUFqSlUsb0JBQWUsR0FBdEIsVUFBdUIsVUFBVTtRQUM3QixJQUFJLGNBQWMsR0FBUSxFQUFFLENBQUM7UUFDN0IsSUFBSSxLQUFLLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO1FBQ2pFLElBQUksV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDekMsSUFBSSxlQUFlLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO1lBQ3RHLElBQUksZUFBZSxLQUFLLElBQUksRUFBRTtnQkFDMUIsY0FBYyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzlFO2lCQUFNO2dCQUNILGVBQWUsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7Z0JBQzFFLElBQUksZUFBZSxLQUFLLElBQUksRUFBRTtvQkFDMUIsY0FBYyxHQUFHLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUMxRTtxQkFBTTtvQkFDSCxjQUFjLEdBQUcsSUFB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LENBQUMsQ0FBQztvQkFDcEMsSUFBSSxPQUFPLEdBQUc7d0JBQ1YsUUFBUSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTt3QkFDeEMsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7d0JBQzVCLFVBQVUsRUFBRSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7cUJBQy9FLENBQUE7b0JBQ0QsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDOUI7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxZQUFZLENBQUM7SUFDeEIsQ0FBQztJQUNMLFdBQUM7QUFBRCxDQUFDLEFBbEpELElBa0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVEhJUyB9IGZyb20gXCIuLi9jb25zdC9hcHAuY29uc3RcIlxyXG5leHBvcnQgY2xhc3MgTGlucSB7XHJcbiAgICBzdGF0aWMgZnVuY3Rpb25DcmVhdG9yKGV4cHJlc3Npb24pOiBhbnkge1xyXG4gICAgICAgIHZhciBmdW5jdGlvblNldHRlcjogYW55ID0gW107XHJcbiAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxccypcXCg/XFxzKihbXildKilcXHMqXFwpP1xccyo9PiguKikvKTtcclxuICAgICAgICB2YXIgc3BsaXRTZWxlY3QgPSBtYXRjaFsyXS5zcGxpdChcIixcIik7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGxpdFNlbGVjdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB2YXIgZXF1YWxUb09wZXJhdG9yID0gc3BsaXRTZWxlY3RbaV0ubWF0Y2goL15cXHMqXFwoP1xccyooW14pXSopXFxzKlxcKT9cXHMqfD09PXwhPT18PT18IT18Pj18Pnw8PXw8fCguKikvKTtcclxuICAgICAgICAgICAgaWYgKGVxdWFsVG9PcGVyYXRvciAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb25TZXR0ZXIgPSBuZXcgRnVuY3Rpb24obWF0Y2hbMV0sIFwicmV0dXJuIFwiICsgZXF1YWxUb09wZXJhdG9yLmlucHV0KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGVxdWFsVG9PcGVyYXRvciA9IHNwbGl0U2VsZWN0W2ldLm1hdGNoKC9eXFxzKlxcKD9cXHMqKFteKV0qKVxccypcXCk/XFxzKj0oLiopLyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXF1YWxUb09wZXJhdG9yID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb25TZXR0ZXIgPSBuZXcgRnVuY3Rpb24obWF0Y2hbMV0sIFwicmV0dXJuIFwiICsgc3BsaXRTZWxlY3QuaW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvblNldHRlciA9IG5ldyBGdW5jdGlvbihtYXRjaFsxXSwgXCJyZXR1cm4gXCIgKyBlcXVhbFRvT3BlcmF0b3IuaW5wdXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzcGxpdFNlbGVjdC5sZW5ndGggPT0gMClcclxuICAgICAgICAgICAgZnVuY3Rpb25TZXR0ZXIgPSB7IGFjY2Vzc0Z1bmN0aW9uOiBuZXcgRnVuY3Rpb24obWF0Y2hbMV0sIFwicmV0dXJuIFwiICsgbWF0Y2hbMl0pIH07XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uU2V0dGVyO1xyXG4gICAgfVxyXG4gICAgc3RhdGljIGV4ZWN1dGUoak9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgY29uZmlnOiBhbnksIHBhcmVudE9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgbW9kZWxJbnN0YW5jZTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgaXNEeW5hbWljQ29uZmlnOiBib29sZWFuKTogYm9vbGVhbiB7XHJcbiAgICAgICAgbGV0IGV4cHJlc3Npb25GdW5jdGlvbjogRnVuY3Rpb24gfCBzdHJpbmcgPSBpc0R5bmFtaWNDb25maWcgPyBjb25maWcuZHluYW1pY0NvbmZpZyA6IGNvbmZpZy5jb25kaXRpb25hbEV4cHJlc3Npb247XHJcbiAgICAgICAgbGV0IGxhc3RQYXJhbSA9IGlzRHluYW1pY0NvbmZpZyA/IGNvbmZpZyA6IG1vZGVsSW5zdGFuY2U7XHJcbiAgICAgICAgaWYgKHBhcmVudE9iamVjdCAmJiB0eXBlb2YgZXhwcmVzc2lvbkZ1bmN0aW9uID09IFwic3RyaW5nXCIpXHJcbiAgICAgICAgICAgIGV4cHJlc3Npb25GdW5jdGlvbiA9IExpbnEuZnVuY3Rpb25DcmVhdG9yKGV4cHJlc3Npb25GdW5jdGlvbik7XHJcbiAgICAgICAgaWYgKHBhcmVudE9iamVjdCAmJiBleHByZXNzaW9uRnVuY3Rpb24pXHJcbiAgICAgICAgICAgIHJldHVybiBtb2RlbEluc3RhbmNlICYmIG1vZGVsSW5zdGFuY2UuY29uc3RydWN0b3IgIT09IE9iamVjdCA/ICg8RnVuY3Rpb24+ZXhwcmVzc2lvbkZ1bmN0aW9uKS5jYWxsKG1vZGVsSW5zdGFuY2UsIHBhcmVudE9iamVjdCwgak9iamVjdCwgbGFzdFBhcmFtKSA6ICg8RnVuY3Rpb24+ZXhwcmVzc2lvbkZ1bmN0aW9uKShwYXJlbnRPYmplY3QsIGpPYmplY3QsIGxhc3RQYXJhbSk7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0Q29uZGl0aW9uUGF0aCh0ZXh0czogc3RyaW5nW10pOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBwYXRoID0gXCJcIjtcclxuICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRleHRzLmxlbmd0aDsgaSsrKVxyXG4gICAgICAgICAgICBwYXRoICs9ICh0ZXh0cy5sZW5ndGggLSAxKSA9PSBpID8gdGV4dHNbaV0udHJpbSgpIDogYCR7dGV4dHNbaV0udHJpbSgpfS5gXHJcbiAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZXhwcmVzc2lvblBhcnNlcihleHByZXNzaW9uOiBhbnksIGlzTm9uVmFsaWRhdGlvbkV4cHJlc3Npb246IGJvb2xlYW4pIHtcclxuICAgICAgICBsZXQgc3BsaXRFeHByZXNzaW9ucyA9IFtdO1xyXG4gICAgICAgIGxldCBjb2x1bW5zID0gW107XHJcbiAgICAgICAgbGV0IGV4cHJlc3Npb25TdHJpbmcgPSBleHByZXNzaW9uLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgbGV0IGV4cHJlc3Npb25Bcmd1bWVudHMgPSBMaW5xLmV4dHJhY3RBcmd1bWVudHMoZXhwcmVzc2lvblN0cmluZyk7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25Bcmd1bWVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBsZXQgc3BsaXRUZXh0cyA9IFtdO1xyXG4gICAgICAgICAgICBleHByZXNzaW9uU3RyaW5nLnJlcGxhY2UoL1xccy9nLCAnJykucmVwbGFjZShuZXcgUmVnRXhwKC97fH0vLCBcImdcIiksIFwiXCIpLnNwbGl0KG5ldyBSZWdFeHAoL3JldHVybnw9PT18IT09fD09fCE9fD49fD58PD18PHwmJi8pKS5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRleHRzID0gdC5yZXBsYWNlKC9cXCh8XFwpL2csIFwiXCIpLnNwbGl0KFwifHxcIik7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCB0ZXh0IG9mIHRleHRzKVxyXG4gICAgICAgICAgICAgICAgICAgIHNwbGl0VGV4dHMucHVzaCh0ZXh0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHNwbGl0VGV4dHMuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb25Bcmd1bWVudHMuZm9yRWFjaCgoeCwgaSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHQgPSB0LnRyaW0oKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodC5zdGFydHNXaXRoKHggKyAnLicpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzcGxpdFRleHQgPSB0LnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcGxpdFRleHQubGVuZ3RoID09IDIgfHwgKHNwbGl0VGV4dC5sZW5ndGggPj0gMiAmJiBpc05vblZhbGlkYXRpb25FeHByZXNzaW9uKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNOb25WYWxpZGF0aW9uRXhwcmVzc2lvbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW5zLnB1c2goeyBwcm9wTmFtZTogc3BsaXRUZXh0WzFdLnRyaW0oKSwgYXJndW1lbnRJbmRleDogaSA9PSAzID8gMCA6IGkgPT0gMiA/IDEgOiBpID09IDEgPyAtMSA6IGkgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1ucy5wdXNoKHsgcHJvcE5hbWU6IHRoaXMuZ2V0Q29uZGl0aW9uUGF0aChzcGxpdFRleHQpLCBhcmd1bWVudEluZGV4OiBpID09IDMgPyAwIDogaSA9PSAyID8gMSA6IGkgPT0gMSA/IC0xIDogaSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXJyYXlQcm9wID0gc3BsaXRUZXh0WzFdLnNwbGl0KCdbJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgak9iamVjdCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wTmFtZTogc3BsaXRUZXh0W3NwbGl0VGV4dC5sZW5ndGggLSAxXS50cmltKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0UHJvcE5hbWU6IGFycmF5UHJvcFswXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcnJheUluZGV4OiBhcnJheVByb3AubGVuZ3RoID4gMSA/IGFycmF5UHJvcFsxXS5yZXBsYWNlKFwiXVwiLCBcIlwiKSA6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudEluZGV4OiBpID09PSAzID8gMCA6IGkgPT09IDIgPyAxIDogaVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1ucy5wdXNoKGpPYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZXh0cmFjdEFyZ3VtZW50cyhzcGxpdFRleHQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgICAgICBsZXQgZXhwcmVzc2lvbkFyZ3VtZW50czogc3RyaW5nW10gPSBbVEhJU107XHJcbiAgICAgICAgaWYgKHNwbGl0VGV4dFswXS50cmltKCkgIT09IFwiKFwiICYmICFzcGxpdFRleHQudHJpbSgpLnN0YXJ0c1dpdGgoXCJmdW5jdGlvblwiKSkge1xyXG4gICAgICAgICAgICBsZXQgdGV4dCA9IHNwbGl0VGV4dFswXS5zcGxpdChcIj0+XCIpWzBdO1xyXG4gICAgICAgICAgICBleHByZXNzaW9uQXJndW1lbnRzLnB1c2godGV4dC50cmltKCkucmVwbGFjZShcIihcIiwgXCJcIikucmVwbGFjZShcIilcIiwgXCJcIikpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHNwbGl0VGV4dHMgPSBzcGxpdFRleHQubWF0Y2goL1xcKChbXildKylcXCkvZyk7XHJcbiAgICAgICAgICAgIGlmIChzcGxpdFRleHRzICYmIHNwbGl0VGV4dHNbMF0pIFxyXG4gICAgICAgICAgICAgICAgICAgIHNwbGl0VGV4dHNbMF0uc3BsaXQoXCIsXCIpLmZvckVhY2godCA9PiBleHByZXNzaW9uQXJndW1lbnRzLnB1c2godC50cmltKCkucmVwbGFjZShcIihcIiwgXCJcIikucmVwbGFjZShcIilcIiwgXCJcIikpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb25Bcmd1bWVudHM7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGV4cHJlc3Npb25Db2x1bW5zKGV4cHJlc3Npb246IGFueSwgaXNOb25WYWxpZGF0aW9uRXhwcmVzc2lvbjogYm9vbGVhbiA9IGZhbHNlKSB7XHJcbiAgICAgICAgdmFyIGNvbHVtbnMgPSBbXTtcclxuICAgICAgICBsZXQgc3BsaXRFeHByZXNzaW9ucyA9IFtdO1xyXG4gICAgICAgIGlmICh0eXBlb2YgZXhwcmVzc2lvbiA9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIGV4cHJlc3Npb24uc3BsaXQoXCI9PlwiKVsxXS5zcGxpdChcIiAmJiBcIikuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgICAgIHQuc3BsaXQoXCIgfHwgXCIpLmZvckVhY2goeCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3BsaXRFeHByZXNzaW9ucy5wdXNoKHgudHJpbSgpLnNwbGl0KCcgJylbMF0pXHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc3BsaXRFeHByZXNzaW9ucy5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNwbGl0VGV4dCA9IHQuc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgICAgIGlmIChzcGxpdFRleHQubGVuZ3RoID09IDIpXHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1ucy5wdXNoKHsgcHJvcE5hbWU6IHNwbGl0VGV4dFsxXS50cmltKCkgfSk7XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYXJyYXlQcm9wID0gc3BsaXRUZXh0WzFdLnNwbGl0KCdbJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGpPYmplY3QgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BOYW1lOiBzcGxpdFRleHRbc3BsaXRUZXh0Lmxlbmd0aCAtIDFdLnRyaW0oKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0UHJvcE5hbWU6IGFycmF5UHJvcFswXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJyYXlJbmRleDogYXJyYXlQcm9wLmxlbmd0aCA+IDEgPyBhcnJheVByb3BbMV0ucmVwbGFjZShcIl1cIiwgXCJcIikgOiB1bmRlZmluZWRcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1ucy5wdXNoKGpPYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgY29sdW1ucyA9IExpbnEuZXhwcmVzc2lvblBhcnNlcihleHByZXNzaW9uLCBpc05vblZhbGlkYXRpb25FeHByZXNzaW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNvbHVtbnM7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGR5bmFtaWNDb25maWdQYXJzZXIoZXhwcmVzc2lvbjogRnVuY3Rpb24sIHByb3BOYW1lOiBzdHJpbmcpOiBhbnlbXSB7XHJcbiAgICAgICAgbGV0IGNvbnRyb2xOYW1lcyA9IFtdO1xyXG4gICAgICAgIGxldCBleHByZXNzaW9uU3RyaW5nID0gZXhwcmVzc2lvbi50b1N0cmluZygpO1xyXG4gICAgICAgIGxldCBleHByZXNzaW9uQXJndW1lbnRzID0gTGlucS5leHRyYWN0QXJndW1lbnRzKGV4cHJlc3Npb25TdHJpbmcpO1xyXG4gICAgICAgIGxldCBzcGxpdFN0cmluZzogc3RyaW5nW10gPSBleHByZXNzaW9uU3RyaW5nLnJlcGxhY2UobmV3IFJlZ0V4cCgvXFxyP1xcbnxcXHJ8Oy9nKSwgJyAnKS5yZXBsYWNlKC9bXCIlKClcXHt9PVxcXFw/77+9YCcjPD58LDs6Ky1dKy9nLCBcIiBcIikuc3BsaXQoLyAvZyk7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25Bcmd1bWVudHMubGVuZ3RoID4gMylcclxuICAgICAgICAgICAgZXhwcmVzc2lvbkFyZ3VtZW50cy5zcGxpY2UoZXhwcmVzc2lvbkFyZ3VtZW50cy5sZW5ndGggLSAxLCAxKVxyXG4gICAgICAgIGV4cHJlc3Npb25Bcmd1bWVudHMuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgc3BsaXRTdHJpbmcuZmlsdGVyKHggPT4geCAhPSBgJHt0fS4ke3Byb3BOYW1lfWAgJiYgeC5zdGFydHNXaXRoKGAke3R9LmApKS5mb3JFYWNoKHggPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHNwbGl0ID0geC5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNwbGl0Lmxlbmd0aCA9PSAyKVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xOYW1lcy5wdXNoKHsgcHJvcE5hbWU6IHgucmVwbGFjZShgJHt0fS5gLCAnJykgfSlcclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhcnJheVByb3AgPSBzcGxpdFsxXS5zcGxpdCgnWycpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBqT2JqZWN0ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wTmFtZTogc3BsaXRbc3BsaXQubGVuZ3RoIC0gMV0udHJpbSgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RQcm9wTmFtZTogYXJyYXlQcm9wWzBdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJheUluZGV4OiBhcnJheVByb3AubGVuZ3RoID4gMSA/IGFycmF5UHJvcFsxXS5yZXBsYWNlKFwiXVwiLCBcIlwiKSA6IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29udHJvbE5hbWVzLnB1c2goak9iamVjdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBjb250cm9sTmFtZXM7XHJcbiAgICB9XHJcbn1cclxuIl19