import { FormArray } from "@angular/forms";
import { VALUE_CHANGED_SYNC, PATCH } from "../const/app.const";
import { isMatched, clone } from './entity.service';
import { ObjectMaker } from '../util/object-maker';
const PROP_ARRAY = "propArray";
export class RxFormArray extends FormArray {
    constructor(arrayObject, controls, validatorOrOpts, asyncValidator, arrayConfig) {
        super(controls, validatorOrOpts, asyncValidator);
        this.arrayObject = arrayObject;
        this.arrayConfig = arrayConfig;
        this._isModified = false;
        this._modified = [];
        this.cloneObject(arrayObject);
    }
    get isModified() {
        return this._isModified;
    }
    push(control, isAddedInstance = false) {
        let formGroup = this.root;
        if (this.arrayObject)
            if (control.modelInstance) {
                if (!isAddedInstance)
                    this.arrayObject.push(control.modelInstance);
                else
                    this.arrayObject[this.arrayObject.length] = control.modelInstance;
            }
        super.push(control);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    }
    patch() {
        this.checkModification();
        if (this.parent)
            this.parent[PATCH]();
    }
    resetForm(options) {
        if (options && options.index >= 0 && options.groupOption) {
            this.controls[options.index].resetForm(options.groupOption);
        }
        else {
            for (var i = 0; i < this._baseValue.length; i++) {
                if (this.controls[i] !== undefined)
                    this.controls[i].resetForm({ value: this._baseValue[i] });
                else if (options && options.pushFunction) {
                    let formGroup = options.pushFunction(this._baseValue[i]);
                    this.push(formGroup);
                }
            }
        }
    }
    commit() {
        this._baseValue = [];
        for (let formGroup of this.controls) {
            formGroup.commit();
            this._baseValue.push(clone(formGroup.value));
        }
        this.patch();
    }
    removeAt(index, isRemovedInstance = false) {
        let formGroup = this.root;
        if (!isRemovedInstance)
            this.arrayObject.splice(index, 1);
        else {
            for (var i = index; i < this.arrayObject.length - 1; i++)
                this.arrayObject[i] = this.arrayObject[i + 1];
            this.arrayObject.pop();
        }
        super.removeAt(index);
        if (formGroup[VALUE_CHANGED_SYNC])
            formGroup.valueChangedSync();
        this.patch();
        this.checkValidation();
    }
    checkValidation() {
        setTimeout(() => {
            if (this.arrayConfig != undefined && this.arrayConfig.allowMaxIndex && this.length > this.arrayConfig.allowMaxIndex)
                this.setErrors(ObjectMaker.toJson(PROP_ARRAY, this.arrayConfig, [this.length, this.arrayConfig.allowMaxIndex]));
            else if (this.errors && this.errors[PROP_ARRAY])
                delete this.errors[PROP_ARRAY];
        });
    }
    checkModification() {
        this._isModified = !(this._baseValue.length == this.controls.length);
        if (!this._isModified)
            for (var i = 0; i < this.controls.length; i++) {
                this._isModified = isMatched(this._baseValue[i], this.controls[i].value);
                if (this._isModified)
                    break;
            }
    }
    cloneObject(value) {
        this._baseValue = [];
        for (let row of value) {
            this._baseValue.push(clone(row));
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicngtZm9ybS1hcnJheS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvIiwic291cmNlcyI6WyJzZXJ2aWNlcy9yeC1mb3JtLWFycmF5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsS0FBSyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUVuRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUE7QUFDbEQsTUFBTSxVQUFVLEdBQVcsV0FBVyxDQUFDO0FBQ3ZDLE1BQU0sT0FBTyxXQUFZLFNBQVEsU0FBUztJQUl0QyxZQUFvQixXQUFrQixFQUFFLFFBQVEsRUFBRSxlQUFxQixFQUFFLGNBQW9CLEVBQVUsV0FBNkQ7UUFDaEssS0FBSyxDQUFDLFFBQVEsRUFBRSxlQUFlLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFEakMsZ0JBQVcsR0FBWCxXQUFXLENBQU87UUFBaUUsZ0JBQVcsR0FBWCxXQUFXLENBQWtEO1FBRjVKLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGNBQVMsR0FBVSxFQUFFLENBQUM7UUFHMUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1YsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLENBQUMsT0FBWSxFQUFFLGtCQUEyQixLQUFLO1FBQy9DLElBQUksU0FBUyxHQUFRLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBSSxJQUFJLENBQUMsV0FBVztZQUNoQixJQUFJLE9BQU8sQ0FBQyxhQUFhLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxlQUFlO29CQUNo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Q3hFLElBQUksSUFBSSxDQUFDLFdBQVc7b0JBQ2hCLE1BQU07YUFDYjtJQUNULENBQUM7SUFFTyxXQUFXLENBQUMsS0FBWTtRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixLQUFLLElBQUksR0FBRyxJQUFJLEtBQUssRUFBRTtZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNwQztJQUNMLENBQUM7Q0FHSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZvcm1BcnJheSB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xyXG5pbXBvcnQgeyBWQUxVRV9DSEFOR0VEX1NZTkMsIFBBVENIIH0gZnJvbSBcIi4uL2NvbnN0L2FwcC5jb25zdFwiO1xyXG5pbXBvcnQgeyBpc01hdGNoZWQsIGNsb25lIH0gZnJvbSAnLi9lbnRpdHkuc2VydmljZSdcclxuaW1wb3J0IHsgUmVzZXRGb3JtVHlwZSB9IGZyb20gXCIuLi9lbnVtcy9yZXNldC10eXBlXCI7XHJcbmltcG9ydCB7IE9iamVjdE1ha2VyIH0gZnJvbSAnLi4vdXRpbC9vYmplY3QtbWFrZXInXHJcbmNvbnN0IFBST1BfQVJSQVk6IHN0cmluZyA9IFwicHJvcEFycmF5XCI7XHJcbmV4cG9ydCBjbGFzcyBSeEZvcm1BcnJheSBleHRlbmRzIEZvcm1BcnJheSB7XHJcbiAgICBwcml2YXRlIF9iYXNlVmFsdWU6IGFueVtdO1xyXG4gICAgcHJpdmF0ZSBfaXNNb2RpZmllZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBfbW9kaWZpZWQ6IGFueVtdID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFycmF5T2JqZWN0OiBhbnlbXSwgY29udHJvbHMsIHZhbGlkYXRvck9yT3B0cz86IGFueSwgYXN5bmNWYWxpZGF0b3I/OiBhbnksIHByaXZhdGUgYXJyYXlDb25maWc/OiB7IGFsbG93TWF4SW5kZXg/OiBudW1iZXIsIG1lc3NhZ2VLZXk/OiBzdHJpbmcgfSkge1xyXG4gICAgICAgIHN1cGVyKGNvbnRyb2xzLCB2YWxpZGF0b3JPck9wdHMsIGFzeW5jVmFsaWRhdG9yKTtcclxuICAgICAgICB0aGlzLmNsb25lT2JqZWN0KGFycmF5T2JqZWN0KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgaXNNb2RpZmllZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faXNNb2RpZmllZDtcclxuICAgIH1cclxuXHJcbiAgICBwdXNoKGNvbnRyb2w6IGFueSwgaXNBZGRlZEluc3RhbmNlOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgICAgICBsZXQgZm9ybUdyb3VwOiBhbnkgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgaWYgKHRoaXMuYXJyYXlPYmplY3QpXHJcbiAgICAgICAgICAgIGlmIChjb250cm9sLm1vZGVsSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNBZGRlZEluc3RhbmNlKVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3QucHVzaChjb250cm9sLm1vZGVsSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJyYXlPYmplY3RbdGhpcy5hcnJheU9iamVjdC5sZW5ndGhdID0gY29udHJvbC5tb2RlbEluc3RhbmNlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXHJcbiAgICAgICAgc3VwZXIucHVzaChjb250cm9sKTtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW1ZBTFVFX0NIQU5HRURfU1lOQ10pXHJcbiAgICAgICAgICAgIGZvcm1Hcm91cC52YWx1ZUNoYW5nZWRTeW5jKClcclxuICAgICAgICB0aGlzLnBhdGNoKClcclxuICAgICAgICB0aGlzLmNoZWNrVmFsaWRhdGlvbigpXHJcbiAgICB9XHJcblxyXG4gICAgcGF0Y2goKSB7XHJcbiAgICAgICAgdGhpcy5jaGVja01vZGlmaWNhdGlvbigpO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudClcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRbUEFUQ0hdKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0Rm9ybShvcHRpb25zPzoge1xyXG4gICAgICAgIGluZGV4OiBudW1iZXIsXHJcbiAgICAgICAgZ3JvdXBPcHRpb246IHtcclxuICAgICAgICAgICAgcmVzZXRUeXBlPzogUmVzZXRGb3JtVHlwZSxcclxuICAgICAgICAgICAgd2l0aD86IHN0cmluZ1tdLFxyXG4gICAgICAgICAgICB2YWx1ZT86IHsgW2tleTogc3RyaW5nXTogYW55IH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHB1c2hGdW5jdGlvbjogKHZhbHVlOiBPYmplY3QpID0+IGJvb2xlYW47XHJcbiAgICB9KSB7XHJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pbmRleCA+PSAwICYmIG9wdGlvbnMuZ3JvdXBPcHRpb24pIHtcclxuICAgICAgICAgICAgKDxhbnk+dGhpcy5jb250cm9sc1tvcHRpb25zLmluZGV4XSkucmVzZXRGb3JtKG9wdGlvbnMuZ3JvdXBPcHRpb24pXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9iYXNlVmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbnRyb2xzW2ldICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgKDxhbnk+dGhpcy5jb250cm9sc1tpXSkucmVzZXRGb3JtKHsgdmFsdWU6IHRoaXMuX2Jhc2VWYWx1ZVtpXSB9KTtcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnB1c2hGdW5jdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZm9ybUdyb3VwID0gb3B0aW9ucy5wdXNoRnVuY3Rpb24odGhpcy5fYmFzZVZhbHVlW2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoKGZvcm1Hcm91cCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgY29tbWl0KCkge1xyXG4gICAgICAgIHRoaXMuX2Jhc2VWYWx1ZSA9IFtdXHJcbiAgICAgICAgZm9yIChsZXQgZm9ybUdyb3VwIG9mIHRoaXMuY29udHJvbHMpIHtcclxuICAgICAgICAgICAgKDxhbnk+Zm9ybUdyb3VwKS5jb21taXQoKTtcclxuICAgICAgICAgICAgdGhpcy5fYmFzZVZhbHVlLnB1c2goY2xvbmUoZm9ybUdyb3VwLnZhbHVlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucGF0Y2goKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcmVtb3ZlQXQoaW5kZXg6IG51bWJlciwgaXNSZW1vdmVkSW5zdGFuY2U6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG4gICAgICAgIGxldCBmb3JtR3JvdXA6IGFueSA9IHRoaXMucm9vdDtcclxuICAgICAgICBpZiAoIWlzUmVtb3ZlZEluc3RhbmNlKVxyXG4gICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBpbmRleDsgaSA8IHRoaXMuYXJyYXlPYmplY3QubGVuZ3RoIC0gMTsgaSsrKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5hcnJheU9iamVjdFtpXSA9IHRoaXMuYXJyYXlPYmplY3RbaSArIDFdO1xyXG4gICAgICAgICAgICB0aGlzLmFycmF5T2JqZWN0LnBvcCgpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHN1cGVyLnJlbW92ZUF0KGluZGV4KTtcclxuICAgICAgICBpZiAoZm9ybUdyb3VwW1ZBTFVFX0NIQU5HRURfU1lOQ10pXHJcbiAgICAgICAgICAgIGZvcm1Hcm91cC52YWx1ZUNoYW5nZWRTeW5jKClcclxuICAgICAgICB0aGlzLnBhdGNoKClcclxuICAgICAgICB0aGlzLmNoZWNrVmFsaWRhdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tWYWxpZGF0aW9uKCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hcnJheUNvbmZpZyAhPSB1bmRlZmluZWQgJiYgdGhpcy5hcnJheUNvbmZpZy5hbGxvd01heEluZGV4ICYmIHRoaXMubGVuZ3RoID4gdGhpcy5hcnJheUNvbmZpZy5hbGxvd01heEluZGV4KVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRFcnJvcnMoT2JqZWN0TWFrZXIudG9Kc29uKFBST1BfQVJSQVksIHRoaXMuYXJyYXlDb25maWcsIFt0aGlzLmxlbmd0aCwgdGhpcy5hcnJheUNvbmZpZy5hbGxvd01heEluZGV4XSkpO1xyXG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLmVycm9ycyAmJiB0aGlzLmVycm9yc1tQUk9QX0FSUkFZXSlcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmVycm9yc1tQUk9QX0FSUkFZXTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tNb2RpZmljYXRpb24oKSB7XHJcbiAgICAgICAgdGhpcy5faXNNb2RpZmllZCA9ICEodGhpcy5fYmFzZVZhbHVlLmxlbmd0aCA9PSB0aGlzLmNvbnRyb2xzLmxlbmd0aCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9pc01vZGlmaWVkKVxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuY29udHJvbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2lzTW9kaWZpZWQgPSBpc01hdGNoZWQodGhpcy5fYmFzZVZhbHVlW2ldLCB0aGlzLmNvbnRyb2xzW2ldLnZhbHVlKVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2lzTW9kaWZpZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsb25lT2JqZWN0KHZhbHVlOiBhbnlbXSkge1xyXG4gICAgICAgIHRoaXMuX2Jhc2VWYWx1ZSA9IFtdO1xyXG4gICAgICAgIGZvciAobGV0IHJvdyBvZiB2YWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9iYXNlVmFsdWUucHVzaChjbG9uZShyb3cpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxufVxyXG4iXX0=